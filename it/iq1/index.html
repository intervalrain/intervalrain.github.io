<!doctype html><html lang=zh-tw dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[IT] LINQ: IQueryable Provider | Rain Hu's Workspace</title>
<meta name=keywords content="LINQ,C#,SQL,DB"><meta name=description content="一系列關於如何建立 LINQ IQueryable Provider 的文章，每篇都是建立在前一篇的基礎上。"><meta name=author content="Rain Hu"><link rel=canonical href=https://intervalrain.github.io/><meta name=google-site-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.662816b9df27c772d2b97c5f5f6bf4f2c5531051a330015f0ad4135736d0e56a.css integrity="sha256-ZigWud8nx3LSuXxfX2v08sVTEFGjMAFfCtQTVzbQ5Wo=" rel="preload stylesheet" as=style><link rel=icon href=https://intervalrain.github.io/images/rain.png><link rel=icon type=image/png sizes=16x16 href=https://intervalrain.github.io/images/rain.png><link rel=icon type=image/png sizes=32x32 href=https://intervalrain.github.io/images/rain.png><link rel=apple-touch-icon href=https://intervalrain.github.io/images/rain.png><link rel=mask-icon href=https://intervalrain.github.io/images/rain.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh-tw href=https://intervalrain.github.io/it/iq1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css integrity=sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js integrity=sha384-GxNFqL3r9uRJQhR+47eDxuPoNE7yLftQM8LcxzgS4HT73tp970WS/wV5p8UzCOmb crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script><script async src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script src=https://utteranc.es/client.js repo=intervalrain.github.io issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script><meta property="og:url" content="https://intervalrain.github.io/it/iq1/"><meta property="og:site_name" content="Rain Hu's Workspace"><meta property="og:title" content="[IT] LINQ: IQueryable Provider"><meta property="og:description" content="一系列關於如何建立 LINQ IQueryable Provider 的文章，每篇都是建立在前一篇的基礎上。"><meta property="og:locale" content="zh-tw"><meta property="og:type" content="article"><meta property="article:section" content="it"><meta property="article:published_time" content="2023-09-21T11:34:15+08:00"><meta property="article:modified_time" content="2023-09-21T11:34:15+08:00"><meta property="article:tag" content="LINQ"><meta property="article:tag" content="C#"><meta property="article:tag" content="IQueryable"><meta name=twitter:card content="summary"><meta name=twitter:title content="[IT] LINQ: IQueryable Provider"><meta name=twitter:description content="一系列關於如何建立 LINQ IQueryable Provider 的文章，每篇都是建立在前一篇的基礎上。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ITs","item":"https://intervalrain.github.io/it/"},{"@type":"ListItem","position":2,"name":"[IT] LINQ: IQueryable Provider","item":"https://intervalrain.github.io/it/iq1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[IT] LINQ: IQueryable Provider","name":"[IT] LINQ: IQueryable Provider","description":"一系列關於如何建立 LINQ IQueryable Provider 的文章，每篇都是建立在前一篇的基礎上。","keywords":["LINQ","C#","SQL","DB"],"articleBody":"可重複使用的 IQueryable 基類 IQueryable 簡介 在 C# 最新版本中的 IQueryable 已經不再是一個介面，而是分為兩個部分： IQueryable 與 IQueryProvider。在開始實作之前，我們必須先了解一下這兩個介面。\npublic interface IQuerable : IEnumerable { Type ElementType { get; } Expression Expression { get; } IQueryProvider Provider { get; } } public interface IQueryable : IEnumerable, IQueryable, IEnumerable { } IQueryable 有三個唯讀屬性：\nElementType 代表了元素的類型 (或等於 IQueryable 中的 T) Expression 代表了查詢對應的表達式。這是 IQueryable 存在的核心要素。在 IQueryable 的內部，實際上是一個表示查詢的表達式，它將查詢表示為 LINQ 查詢運算子/方法調用的樹狀結構。如果進一步看，你會發現，IQueryable 或是 Queryable 都只是在提供一個自動構建表達式樹節點 (expression tree nodes) 的機制。當我們對 IQeuryable 使用 Where 方法時，它只是回傳一個新的 IQueryable，並且在進行調用的樹頂添加一個方法表達式樹節點。 Provider 作為真正的「提供者」，它負責原先所有 IQueryable 的執行方法。 IQueryProvider 簡介 public interface IQueryProvider { IQueryable CreateQuery(Expression expression); IQueryable CreateQuery(Expression expression); object Execute(Expression expression); TResult Execute(Expression expression); } 當我們進一步觀察 IQueryProvider，會發現它事實上只有兩個操作：CreateQuery、Execute，只是各有一個泛型與非泛型的方法。一般我們會使用泛型的方法，因為它可以避免使用反射來建構實例，從而提高性能。\nCreateQuery 人如其名，它基於指定的表達樹建構 IQueryable 的實例。標準查詢運算子 Queryable 會使用這個方法來建構與 Provider 相關聯的新的 IQueryable。 需注意，使用者可以任意向 API 傳遞任何可能的表達樹，甚至不是合法的查詢，然而，它的回傳值必定要是 IQueryable。 Execute 是進入 Provider 的入口，用於實際執行查詢表達式。擁有一個明確的執行方法而不僅僅依賴於 IEnumerable.GetEnumerator() 是非常重要的，因為它允許執行時不一定要產生序列。比方說，myquery.Count() 回傳一個整數，該查詢的表達樹是調用一個 Count 方法並回傳整數，其它的聚合方法也是同樣的道理，都是即時的執行方法。 Query 實作 IQueryable 首先，我們從 IQueryable 開始，因為現在這個介面被分為兩個部分，所以我們可以只實現 IQueryable 一次，並在其它的 QueryProvider 中重複使用它。\npublic class Query : IQueryable, IQueryable, IEnumerable, IEnumerable, IOrderedQueryable, IOrderedQueryable { QueryProvider provider; Expression expression; public Query(QueryProvider provider) { if (provider == null) throw new ArgumentNullException(\"provider\"); this.provider = provider; this.expression = Expression.Constant(this); } public Query(QueryProvider provider, Expression expression) { if (provider == null) throw new ArgumentNullException(\"provider\"); if (expression == null) throw new ArgumentNullException(\"expression\"); if (!typeof(IQueryable).IsAssignableFrom(expression.Type)) throw new ArgumentOutOfRangeException(\"expression\"); this.provider = provider; this.expression = expression; } Expression IQueryable.Expression { get { return this.expression; } } Type IQueryable.ElementType { get { return typeof(T); } } IQueryProvider IQueryable.Provider { get { return this.provider; } } public IEnumerator GetEnumerator() { return ((IEnumerable)this.provider.Execute(this.expression)).GetEnumerator(); } IEnumerator IEnumerable.GetEnumerator() { return ((IEnumerable)this.provider.Execute(this.expression)).GetEnumerator(); } public override string ToString() { return this.provider.GetQueryText(this.expression); } } 如你所見，上面的 Query 只用來保存一個 Expression 與一個 Provider。Provider才是真正核心的地方。\nQueryProvider 實作 IQueryProvider public abstract class QueryProvider : IQueryProvider { public QueryProvider() { } IQueryable IQueryProvider.CreateQuery(Expression expression) { return new Query(this, expression); } IQueryable IQueryProvider.CreateQuery(Expression expression) { Type elementType = TypeManager.GetElementType(expression.Type); try { return (IQueryable)Activator.CreateInstance(typeof(Query\u003c\u003e).MakeGenericType(elementType), new object[] { this, expression }); } catch (Exception tie) { throw tie.InnerException; } } S IQueryProvider.Execute(Expression expression) { return (S)this.Execute(expression); } object IQueryProvider.Execute(Expression expression) { return this.Execute(expression); } public abstract string GetQueryText(Expression expression); public abstract object Execute(Expression expression); } 我們先是用 QueryProvider 實作了 IQueryProvider 的基類別。這些 CreateQuery 方法創建了 Query 的新實例，並將執行轉發到尚未實作的 Execute 方法。\n接下來我們可以將之視為樣板，只是為了開始建立一個 LINQ 的 IQueryable 的 provider。真正的執行將會發生在 Execute 的內部，屆時，provider 可以真正通過檢查表達樹來理解查詢的含義。\n[Helper] TypeManager TypeManager 用來處理非泛型的方法，檢查其型別。\ninternal static class TypeManager { internal static Type GetElementType(Type seqType) { Type? ienum = FindIEnumerable(seqType); if (ienum == null) return seqType; return ienum.GetGenericArguments()[0]; } private static Type? FindIEnumerable(Type seqType) { if (seqType == null || seqType == typeof(string)) return null; if (seqType.IsArray) return typeof(IEnumerable\u003c\u003e).MakeGenericType(seqType.GetElementType()); if (seqType.IsGenericType) { foreach (Type arg in seqType.GetGenericArguments()) { Type ienum = typeof(IEnumerable\u003c\u003e).MakeGenericType(arg); if (ienum.IsAssignableFrom(seqType)) return ienum; } } Type[] ifaces = seqType.GetInterfaces(); if (ifaces != null \u0026\u0026 ifaces.Length \u003e 0) { foreach (Type iface in ifaces) { Type? ienum = FindIEnumerable(iface); if (ienum != null) return ienum; } } if (seqType.BaseType != null \u0026\u0026 seqType.BaseType != typeof(object) ) { return FindIEnumerable(seqType.BaseType); } return null; } } Where 和可重複使用的表達樹詢問器 (Expression tree visitor) 在建立好基類別 Query 與 QueryProvider 後，我們將繼續建立一個實際執行某些操作的 provider。Query Provider 實際上執行的是一小最被定義為表達樹的程式碼，而不是 IL。當然，它不需要傳統意義上的方式執行它，例如 LINQ to SQL 將查詢表達式轉換為 SQL，並將其發送到伺服器上執行。\n接下來的範例將會舉 LINQ to SQL 很相近，它會將查詢翻譯並執行到一個 ADO provider。在此，我們只打算處理 Where 這個操作，不會做其它更複雜的判斷。將來可能會對它進行擴展，但目前僅為了說明目的。\n要注意 provider 必須要做到兩件事：\n將查詢轉換成 SQL。 將執行命令的結果轉換成物件。 查詢翻譯器 (Query Translator) 查詢翻譯器將簡單地訪問表達樹中的每個節點，並使用 StringBuilder 將操作轉換成文本。為了說明方便，我們在這裡假設有個 ExpressionVisitor 類，為表達樹節點定義了基本的訪問者模式。\ninternal class QueryTranslator : ExpressionVisitor { StringBuilder sb; internal QueryTranslator() { } internal string Translate(Expression expression) { sb = new StringBuilder(); Visit(expression); return sb.ToString(); } private static Expression StripQuotes(Expression e) { while (e.NodeType == ExpressionType.Quote) { e = ((UnaryExpression)e).Operand; } return e; } protected override Expression VisitMethodCall(MethodCallExpression m) { if (m.Method.DeclaringType == typeof(Queryable) \u0026\u0026 m.Method.Name == \"Where\") { sb.Append(\"Select * From (\"); Visit(m.Arguments[0]); sb.Append(\") As T Where \"); LambdaExpression lambda = (LambdaExpression)StripQuotes(m.Arguments[1]); Visit(lambda.Body); return m; } throw new NotSupportedException(string.Format(\"The method '{0}' is not supported\", m.Method.Name)); } protected override Expression VisitUnary(UnaryExpression u) { switch (u.NodeType) { case ExpressionType.Not: sb.Append(\" Not \"); Visit(u.Operand); break; default: throw new NotSupportedException(string.Format(\"The unary operator '{0}' is not supported\", u.NodeType)); } return u; } protected override Expression VisitBinary(BinaryExpression b) { sb.Append(\"(\"); Visit(b.Left); switch (b.NodeType) { case ExpressionType.Add: sb.Append(\" And \"); break; case ExpressionType.Or: sb.Append(\" Or \"); break; case ExpressionType.Equal: sb.Append(\" = \"); break; case ExpressionType.NotEqual: sb.Append(\" \u003c\u003e \"); break; case ExpressionType.LessThan: sb.Append(\" \u003c \"); break; case ExpressionType.LessThanOrEqual: sb.Append(\" \u003c= \"); break; case ExpressionType.GreaterThan: sb.Append(\" \u003e \"); break; case ExpressionType.GreaterThanOrEqual: sb.Append(\" \u003e= \"); break; default: throw new NotSupportedException(string.Format(\"The binary operator '{0}' is not supported\", b.NodeType)); } Visit(b.Right); sb.Append(\")\"); return b; } protected override Expression VisitConstant(ConstantExpression c) { IQueryable? q = c.Value as IQueryable; if (q != null) { sb.Append(\"Select * From \"); sb.Append(q.ElementType.Name); } else if (c.Value == null) { sb.Append(\"Null\"); } else { switch (Type.GetTypeCode(c.Value.GetType())) { case TypeCode.Boolean: sb.Append(((bool)c.Value) ? 1 : 0); break; case TypeCode.String: sb.Append(\"'\"); sb.Append(c.Value); sb.Append(\"'\"); break; case TypeCode.Object: throw new NotSupportedException(string.Format(\"The constant for '{0}' is not supported\", c.Value)); default: sb.Append(c.Value); break; } } return c; } protected override Expression VisitMemberAccess(MemberExpression m) { if (m.Expression != null \u0026\u0026 m.Expression.NodeType == ExpressionType.Parameter) { sb.Append(m.Member.Name); return m; } throw new NotSupportedException(string.Format(\"The member '{0}' is not supported\", m.Member.Name)) } } 儘管我們只針對 Where 進行了實作，但仍然相當的複雜。我希望在表達樹中看到的是一個方法的調用，其中參數引用了資料源(source, arg[0])，與謂詞(predicate, arg[1])。參考 VisitMethodCall 方法，我們明確地處理了 Queryable.Where 方法，生成一個 \"Select * From (\" 的字串，然後遞迴訪問資料源後，加上了 ) As T Where，最後再訪問謂詞。這樣可以用嵌套的方式處理資料源中可能出現子查詢的可能。在不考慮其它操作子的情況下，我們可以很優雅的處理 Where 方法。在此表的別名是無關的，因為我們並無對它做任何引用，當然在一個完善的 provider，將有可能對它進行引用。\n這裡包含了一個 helper StripQuotes，它的作用是去除方法參數中的任何 ExpressionType.Quote 節點，以便取得純粹的 lambda 表達式。\nVisitUnary 和 VisitBinary 方法很直白，它們將一元與二元運算子翻譯成文本。\nVisitConstant，在我們的架構中，我們的源引用(table reference)其實就是 IQueryable 的根。如果有一個常數根作為 Query 實例，那麼我們可以假設它代表源引用(子查詢)，所以我們可以用 \"Select * From\" 與查詢元素類型的名稱(ElementType.Name)，即表的名稱。至於其它的常數節點，就是簡單的實際常數，對文本需要以加上單引號。注意，在此並無處理 SQL injection，真正的 provider 需要處理這一部分。\n最後，VisitMemberAccess 假設所有的欄位或屬性存取都是指令文字中的欄位參考。在這裡省略了證明，並假設欄位或屬性的名稱與資料庫中的欄位名稱相符。\n給定一個 Product 類別，其欄位與 All_product 資料庫中的欄位名稱相符，此查詢轉譯器將生成以下形式的查詢：\nQuery products = ...; IQueryable q = products.Where(p =\u003e p.Generation = \"L22\"); 對應的 SQL 語句：\nSelect * From ( Select * From Customers ) As T Where (Generation = 'L22') 物件閱讀器 (Object Reader) 物件閱讀器的工作是將 SQL 查詢的結果轉換為物件。這裡會建立一個簡單的類別，在建構子中會需要一個 DbDataReader，並且接受一個泛型類型 T 以繼承 IEnumerable。實作的部分也沒有什麼花俏的，只能透過射將數據寫入類別的 fields 中，所以需要注意的只有 field 的名稱需要跟 reader 中的欄位名稱相符、類型也必須要相符。\ninternal class ObjectReader : IEnumerable, IEnumerable where T : class, new() { Enumerator? enumerator; public ObjectReader(DbDataReader reader) { enumerator = new Enumerator(reader); } public IEnumerator GetEnumerator() { Enumerator? e = enumerator; if (e == null) throw new InvalidOperationException(\"Cannot enumerate more than once\"); enumerator = null; return e; } IEnumerator IEnumerable.GetEnumerator() { return GetEnumerator(); } class Enumerator : IEnumerator, IEnumerator, IDisposable { DbDataReader reader; FieldInfo[] fields; int[] fieldLookup; T current; internal Enumerator(DbDataReader reader) { this.reader = reader; this.fields = typeof(T).GetFields(); } public T Current =\u003e current; object IEnumerator.Current =\u003e current; public bool MoveNext() { if (reader.Read()) { if (fieldLookup == null) { InitFieldLookup(); } T instance = new T(); for (int i = 0, n = fields.Length; i \u003c n; i++) { int index = fieldLookup[i]; if (index \u003e= 0) { FieldInfo fi = fields[i]; if (reader.IsDBNull(index)) { fi.SetValue(instance, null); } else { fi.SetValue(instance, reader.GetValue(index)); } } } current = instance; return true; } return false; } public void Reset() { } public void Dispose() { reader.Dispose(); } private void InitFieldLookup() { var map = new Dictionary\u003cstring, int\u003e(StringComparer.InvariantCultureIgnoreCase); for (int i = 0, n = reader.FieldCount; i \u003c n; i++) { map.Add(reader.GetName(i), i); } fieldLookup = new int[fields.Length]; for (int i = 0, n = fields.Length; i \u003c n; i++) { if (map.TryGetValue(fields[i].Name, out int index)) { fieldLookup[i] = index; } else { fieldLookup[i] = -1; } } } } } ObjectReader 為每一行由 DbDataReader 讀取的類型 T 創建一個新的實例。它使用反射 API FieldInfo.SetValue 為對象物件的每個 field 分配值。當 ObjectReader 首次創建時，它實例化嵌套的 Enumerator 類的實例。當調用 GetEnumerator 方法時，將分發此枚舉器。由於 DataReader 無法重置並再次執行，因此枚舉器只能分發一次。如果第二次調用 GetEnumerator，則會拋出異常。\nObjectReader 在 field 上的排序是寬鬆的。由於 QueryTranslator 使用了 Select * 建構查詢，這是必須的，否則程式無法知道結果中哪個欄位會首先出現。注意，一般程式中不建議使用 Select *。為了允許不同欄的順序，在讀取 DataReader 的第一行時，精確的順序會在執行期被定義。InitFieldLookup 方法構建了一個從欄位名稱對欄位索引對映射，並組裝了一個查找表 fieldLookup，用於將物件的 fields 與索引進行映射。\n提供者 (Provider) 現在我們已經有了 IQueryable 與 QueryProvider 的基礎建設，要將它們結合在一起製作一個實際的 IQueryable LINQ Provider 就很容易了。\npublic class DbQueryProvider : QueryProvider { private readonly DbConnection connection; public DbQueryProvider(DbConnection connection) { this.connection = connection; } public override string GetQueryText(Expression expression) { return Translate(expression); } public override object Execute(Expression expression) { DbCommand cmd = connection.CreateCommand(); cmd.CommandText = Translate(expression); DbDataReader reader = cmd.ExecuteReader(); Type elementType = TypeManager.GetElementType(expression.Type); return Activator.CreateInstance( typeof(ObjectReader\u003c\u003e).MakeGenericType(elementType), BindingFlags.Instance | BindingFlags.NonPublic, null, new object[] { reader }, null); } private string Translate(Expression expression) { return new QueryTranslator().Translate(expression); } } Try it out 現在有了 provider，我們可以按照 LINQ to SQL 模型進行操作。\npublic class Customers { public string CustomerId; public string ContactName; public string Phone; public string City; public string Country; } public class Orders { public int OrderId; public string CustomerId; public DateTime OrderDate; } public class Northwind { public Query Customers; public Query Orders; public Northwind(DbConnection connection) { QueryProvider provider = new DbQueryProvider(connection); Customers = new Query(provider); Orders = new Query(provider); } } public class Program { public static void Main(string[] args) { string connstr = @\"...\"; using (var conn = new SqlConnection(connstr)) { conn.Open(); Northwind db = new Northwind(conn); IQueryable query = db.Customers.Where(c =\u003e c.City == \"London\"); Console.WriteLine(\"Query:\\n{0}\\n\", query); var list = query.ToList(); foreach (var item in list) { Console.WriteLine(\"Name: {0}\", item.ContactName); } Console.ReadLine(); } } } [Helper] 表達式訪問者 (Expression Visitor) 這個表達式訪問者是一種訪問者模式的呈現。在這個變體中，只有一個訪問者類別，將調用分派到對應於不同節點類型的特定 VisitXXX 方法的一般訪問函數。注意，並非每個節點類型都有自己的方法，例如所有二元運算子都在一個 VisitBinary 方法中處理。節點本身不直接參與訪問的過程，它們只被視為數據。這樣做的原因是訪問者的數量實際上是開放的。因此，訪問的語義並未耦合到節點類別中，而是完全由訪問者控制。節點的默認訪問行為已經內置在基類的 VisitXXX 版本中了。\n另一個變體是所有 VisitXXX 方法都返回一個節點。樹節點是不可變的，為了改變樹，必須要構建一個新的樹。如果任何子樹發生變化，默認的 VisitXXX 方法將構建一個新的節點。如果沒有進行任何更改，則返回相同的節點。這樣，如果在樹的深處進行了一個更改，則整個樹將自動重新構建。\npublic abstract class ExpressionVisitor { protected ExpressionVisitor() { } protected virtual Expression Visit(Expression exp) { if (exp == null) return exp; switch (exp.NodeType) { case ExpressionType.Negate: case ExpressionType.NegateChecked: case ExpressionType.Not: case ExpressionType.Convert: case ExpressionType.ConvertChecked: case ExpressionType.ArrayLength: case ExpressionType.Quote: case ExpressionType.TypeAs: return this.VisitUnary((UnaryExpression)exp); case ExpressionType.Add: case ExpressionType.AddChecked: case ExpressionType.Subtract: case ExpressionType.SubtractChecked: case ExpressionType.Multiply: case ExpressionType.MultiplyChecked: case ExpressionType.Divide: case ExpressionType.Modulo: case ExpressionType.And: case ExpressionType.AndAlso: case ExpressionType.Or: case ExpressionType.OrElse: case ExpressionType.LessThan: case ExpressionType.LessThanOrEqual: case ExpressionType.GreaterThan: case ExpressionType.GreaterThanOrEqual: case ExpressionType.Equal: case ExpressionType.NotEqual: case ExpressionType.Coalesce: case ExpressionType.ArrayIndex: case ExpressionType.RightShift: case ExpressionType.LeftShift: case ExpressionType.ExclusiveOr: return this.VisitBinary((BinaryExpression)exp); case ExpressionType.TypeIs: return this.VisitTypeIs((TypeBinaryExpression)exp); case ExpressionType.Conditional: return this.VisitConditional((ConditionalExpression)exp); case ExpressionType.Constant: return this.VisitConstant((ConstantExpression)exp); case ExpressionType.Parameter: return this.VisitParameter((ParameterExpression)exp); case ExpressionType.MemberAccess: return this.VisitMemberAccess((MemberExpression)exp); case ExpressionType.Call: return this.VisitMethodCall((MethodCallExpression)exp); case ExpressionType.Lambda: return this.VisitLambda((LambdaExpression)exp); case ExpressionType.New: return this.VisitNew((NewExpression)exp); case ExpressionType.NewArrayInit: case ExpressionType.NewArrayBounds: return this.VisitNewArray((NewArrayExpression)exp); case ExpressionType.Invoke: return this.VisitInvocation((InvocationExpression)exp); case ExpressionType.MemberInit: return this.VisitMemberInit((MemberInitExpression)exp); case ExpressionType.ListInit: return this.VisitListInit((ListInitExpression)exp); default: throw new Exception(string.Format(\"Unhandled expression type: '{0}'\", exp.NodeType)); } } protected virtual MemberBinding VisitBinding(MemberBinding binding) { switch (binding.BindingType) { case MemberBindingType.Assignment: return this.VisitMemberAssignment((MemberAssignment)binding); case MemberBindingType.MemberBinding: return this.VisitMemberMemberBinding((MemberMemberBinding)binding); case MemberBindingType.ListBinding: return this.VisitMemberListBinding((MemberListBinding)binding); default: throw new Exception(string.Format(\"Unhandled binding type '{0}'\", binding.BindingType)); } } protected virtual ElementInit VisitElementInitializer(ElementInit initializer) { ReadOnlyCollection arguments = this.VisitExpressionList(initializer.Arguments); if (arguments != initializer.Arguments) { return Expression.ElementInit(initializer.AddMethod, arguments); } return initializer; } protected virtual Expression VisitUnary(UnaryExpression u) { Expression operand = this.Visit(u.Operand); if (operand != u.Operand) { return Expression.MakeUnary(u.NodeType, operand, u.Type, u.Method); } return u; } protected virtual Expression VisitBinary(BinaryExpression b) { Expression left = this.Visit(b.Left); Expression right = this.Visit(b.Right); Expression conversion = this.Visit(b.Conversion); if (left != b.Left || right != b.Right || conversion != b.Conversion) { if (b.NodeType == ExpressionType.Coalesce \u0026\u0026 b.Conversion != null) return Expression.Coalesce(left, right, conversion as LambdaExpression); else return Expression.MakeBinary(b.NodeType, left, right, b.IsLiftedToNull, b.Method); } return b; } protected virtual Expression VisitTypeIs(TypeBinaryExpression b) { Expression expr = this.Visit(b.Expression); if (expr != b.Expression) { return Expression.TypeIs(expr, b.TypeOperand); } return b; } protected virtual Expression VisitConstant(ConstantExpression c) { return c; } protected virtual Expression VisitConditional(ConditionalExpression c) { Expression test = this.Visit(c.Test); Expression ifTrue = this.Visit(c.IfTrue); Expression ifFalse = this.Visit(c.IfFalse); if (test != c.Test || ifTrue != c.IfTrue || ifFalse != c.IfFalse) { return Expression.Condition(test, ifTrue, ifFalse); } return c; } protected virtual Expression VisitParameter(ParameterExpression p) { return p; } protected virtual Expression VisitMemberAccess(MemberExpression m) { Expression exp = this.Visit(m.Expression); if (exp != m.Expression) { return Expression.MakeMemberAccess(exp, m.Member); } return m; } protected virtual Expression VisitMethodCall(MethodCallExpression m) { Expression obj = this.Visit(m.Object); IEnumerable args = this.VisitExpressionList(m.Arguments); if (obj != m.Object || args != m.Arguments) { return Expression.Call(obj, m.Method, args); } return m; } protected virtual ReadOnlyCollection VisitExpressionList(ReadOnlyCollection original) { List list = null; for (int i = 0, n = original.Count; i \u003c n; i++) { Expression p = this.Visit(original[i]); if (list != null) { list.Add(p); } else if (p != original[i]) { list = new List(n); for (int j = 0; j \u003c i; j++) { list.Add(original[j]); } list.Add(p); } } if (list != null) { return list.AsReadOnly(); } return original; } protected virtual MemberAssignment VisitMemberAssignment(MemberAssignment assignment) { Expression e = this.Visit(assignment.Expression); if (e != assignment.Expression) { return Expression.Bind(assignment.Member, e); } return assignment; } protected virtual MemberMemberBinding VisitMemberMemberBinding(MemberMemberBinding binding) { IEnumerable bindings = this.VisitBindingList(binding.Bindings); if (bindings != binding.Bindings) { return Expression.MemberBind(binding.Member, bindings); } return binding; } protected virtual MemberListBinding VisitMemberListBinding(MemberListBinding binding) { IEnumerable initializers = this.VisitElementInitializerList(binding.Initializers); if (initializers != binding.Initializers) { return Expression.ListBind(binding.Member, initializers); } return binding; } protected virtual IEnumerable VisitBindingList(ReadOnlyCollection original) { List list = null; for (int i = 0, n = original.Count; i \u003c n; i++) { MemberBinding b = this.VisitBinding(original[i]); if (list != null) { list.Add(b); } else if (b != original[i]) { list = new List(n); for (int j = 0; j \u003c i; j++) { list.Add(original[j]); } list.Add(b); } } if (list != null) return list; return original; } protected virtual IEnumerable VisitElementInitializerList(ReadOnlyCollection original) { List list = null; for (int i = 0, n = original.Count; i \u003c n; i++) { ElementInit init = this.VisitElementInitializer(original[i]); if (list != null) { list.Add(init); } else if (init != original[i]) { list = new List(n); for (int j = 0; j \u003c i; j++) { list.Add(original[j]); } list.Add(init); } } if (list != null) return list; return original; } protected virtual Expression VisitLambda(LambdaExpression lambda) { Expression body = this.Visit(lambda.Body); if (body != lambda.Body) { return Expression.Lambda(lambda.Type, body, lambda.Parameters); } return lambda; } protected virtual NewExpression VisitNew(NewExpression nex) { IEnumerable args = this.VisitExpressionList(nex.Arguments); if (args != nex.Arguments) { if (nex.Members != null) return Expression.New(nex.Constructor, args, nex.Members); else return Expression.New(nex.Constructor, args); } return nex; } protected virtual Expression VisitMemberInit(MemberInitExpression init) { NewExpression n = this.VisitNew(init.NewExpression); IEnumerable bindings = this.VisitBindingList(init.Bindings); if (n != init.NewExpression || bindings != init.Bindings) { return Expression.MemberInit(n, bindings); } return init; } protected virtual Expression VisitListInit(ListInitExpression init) { NewExpression n = this.VisitNew(init.NewExpression); IEnumerable initializers = this.VisitElementInitializerList(init.Initializers); if (n != init.NewExpression || initializers != init.Initializers) { return Expression.ListInit(n, initializers); } return init; } protected virtual Expression VisitNewArray(NewArrayExpression na) { IEnumerable exprs = this.VisitExpressionList(na.Expressions); if (exprs != na.Expressions) { if (na.NodeType == ExpressionType.NewArrayInit) { return Expression.NewArrayInit(na.Type.GetElementType(), exprs); } else { return Expression.NewArrayBounds(na.Type.GetElementType(), exprs); } } return na; } protected virtual Expression VisitInvocation(InvocationExpression iv) { IEnumerable args = this.VisitExpressionList(iv.Arguments); Expression expr = this.Visit(iv.Expression); if (args != iv.Arguments || expr != iv.Expression) { return Expression.Invoke(expr, args); } return iv; } } 本地變量參考 (Local Variable References) 至此，我們已經建立了一個 provider，但它只能操作一些查詢運算子和一些次要的運算子，例如比較運算子等等。然後，真正的 provider 不得不處理更多運算子與它們之間的複雜操作。\n翻譯本地變數參考 (Translate Local Variable References) 假如我們需要用參考本地變數的方式來進行參詢，例如：\nstring city = \"London\"; var query = db.Customers.Where(c =\u003e c.City == city); 在目前的設計會丟出一個異常: The member 'city' is not supported，city 應該是其中一個欄位，不應是 member，所以我們進一步看向表達式樹的 ToString() 所丟出的結果：\nSelect * From Customers.Where(c =\u003e return (c.City = value(Sample.Program+\u003c\u003ec__DisplayClass0).city)) 原來 C# 編譯器已經創建了一個類來保存在 lambda 表達式中被引用的局部變數了。當局部變數在匿名方法中被引用時，它也會做同樣的事情。\n無論如何，如果我們想讓 provider 與本地變數的參考一起工作，我們就必須處理它。也許我們可以只識別這些編譯器生成的類型的 field 引用，那我們該如何識別編譯器生成的類型？根據名稱嗎？如果 C# 編譯器改變了它們命名方式怎麼辦？如果另一種語言使用了不同的方案呢？本地變數是唯一的情況嗎？那麼在範圍內引用成員變數呢？它們也不會被編碼成樹中的值。最好的情況是，它們是一個常數節點，引用該成員所在的實例，或是一個 MemberAccess 的節點，用於訪問該實例上的成員。我們能否只識別對常數節點的任何成員訪問，並使用反射手動評估它？也許可以，但如果編譯器生成了更複雜的東西呢？ 我們要做的是在整個樹中識別可以立即評估並轉換值的子樹，如果我們能做到這一點，那麼翻譯器的其餘部分只需要處理這些值。\npublic static Expression PartialEval(Expression expression, Func","wordCount":"3839","inLanguage":"zh-tw","datePublished":"2023-09-21T11:34:15+08:00","dateModified":"2023-09-21T11:34:15+08:00","author":{"@type":"Person","name":"Rain Hu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://intervalrain.github.io/it/iq1/"},"publisher":{"@type":"Organization","name":"Rain Hu's Workspace","logo":{"@type":"ImageObject","url":"https://intervalrain.github.io/images/rain.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://intervalrain.github.io/ accesskey=h title="Rain Hu's Workspace (Alt + H)"><img src=https://intervalrain.github.io/images/rain.png alt aria-label=logo height=35>Rain Hu's Workspace</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://intervalrain.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://intervalrain.github.io/aboutme title="About me"><span>About me</span></a></li><li><a href=https://intervalrain.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://intervalrain.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://intervalrain.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://intervalrain.github.io/csharp/csharp title=C#><span>C#</span></a></li><li><a href=https://intervalrain.github.io/csindex title=CS><span>CS</span></a></li><li><a href=https://intervalrain.github.io/leetcode title=LeetCode><span>LeetCode</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://intervalrain.github.io/>首頁</a>&nbsp;»&nbsp;<a href=https://intervalrain.github.io/it/>ITs</a></div><h1 class="post-title entry-hint-parent">[IT] LINQ: IQueryable Provider</h1><div class=post-description>一系列關於如何建立 LINQ IQueryable Provider 的文章，每篇都是建立在前一篇的基礎上。</div><div class=post-meta><span title='2023-09-21 11:34:15 +0800 +0800'>September 21, 2023</span>&nbsp;·&nbsp;19 分鐘&nbsp;·&nbsp;Rain Hu&nbsp;|&nbsp;<a href=https://github.com/intervalrain/intervalrain.github.io/tree/main/content//IT/iq1.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目錄</span></summary><div class=inner><ul><li><a href=#%e5%8f%af%e9%87%8d%e8%a4%87%e4%bd%bf%e7%94%a8%e7%9a%84-iqueryable-%e5%9f%ba%e9%a1%9e aria-label="可重複使用的 IQueryable 基類">可重複使用的 IQueryable 基類</a><ul><li><a href=#iqueryable-%e7%b0%a1%e4%bb%8b aria-label="IQueryable 簡介">IQueryable 簡介</a></li><li><a href=#iqueryprovider-%e7%b0%a1%e4%bb%8b aria-label="IQueryProvider 簡介">IQueryProvider 簡介</a></li><li><a href=#query-%e5%af%a6%e4%bd%9c-iqueryable aria-label="Query 實作 IQueryable">Query 實作 IQueryable</a></li><li><a href=#queryprovider-%e5%af%a6%e4%bd%9c-iqueryprovider aria-label="QueryProvider 實作 IQueryProvider">QueryProvider 實作 IQueryProvider</a></li><li><a href=#helper-typemanager aria-label="[Helper] TypeManager">[Helper] TypeManager</a></li></ul></li><li><a href=#where-%e5%92%8c%e5%8f%af%e9%87%8d%e8%a4%87%e4%bd%bf%e7%94%a8%e7%9a%84%e8%a1%a8%e9%81%94%e6%a8%b9%e8%a9%a2%e5%95%8f%e5%99%a8-expression-tree-visitor aria-label="Where 和可重複使用的表達樹詢問器 (Expression tree visitor)">Where 和可重複使用的表達樹詢問器 (Expression tree visitor)</a><ul><li><a href=#%e6%9f%a5%e8%a9%a2%e7%bf%bb%e8%ad%af%e5%99%a8-query-translator aria-label="查詢翻譯器 (Query Translator)">查詢翻譯器 (Query Translator)</a></li><li><a href=#%e7%89%a9%e4%bb%b6%e9%96%b1%e8%ae%80%e5%99%a8-object-reader aria-label="物件閱讀器 (Object Reader)">物件閱讀器 (Object Reader)</a></li><li><a href=#%e6%8f%90%e4%be%9b%e8%80%85-provider aria-label="提供者 (Provider)">提供者 (Provider)</a></li><li><a href=#try-it-out aria-label="Try it out">Try it out</a></li><li><a href=#helper-%e8%a1%a8%e9%81%94%e5%bc%8f%e8%a8%aa%e5%95%8f%e8%80%85-expression-visitor aria-label="[Helper] 表達式訪問者 (Expression Visitor)">[Helper] 表達式訪問者 (Expression Visitor)</a></li></ul></li><li><a href=#%e6%9c%ac%e5%9c%b0%e8%ae%8a%e9%87%8f%e5%8f%83%e8%80%83-local-variable-references aria-label="本地變量參考 (Local Variable References)">本地變量參考 (Local Variable References)</a><ul><li><a href=#%e7%bf%bb%e8%ad%af%e6%9c%ac%e5%9c%b0%e8%ae%8a%e6%95%b8%e5%8f%83%e8%80%83-translate-local-variable-references aria-label="翻譯本地變數參考 (Translate Local Variable References)">翻譯本地變數參考 (Translate Local Variable References)</a></li></ul></li><li><a href=#select aria-label=Select>Select</a><ul><li><a href=#columnprojector-%e5%af%a6%e4%bd%9c aria-label="ColumnProjector 實作">ColumnProjector 實作</a></li><li><a href=#%e6%94%b9%e5%af%ab-querytranslator aria-label="改寫 QueryTranslator">改寫 QueryTranslator</a></li><li><a href=#%e6%94%b9%e5%af%ab-projection-reader aria-label="改寫 Projection Reader">改寫 Projection Reader</a></li><li><a href=#%e6%94%b9%e5%af%ab-dbqueryprovider aria-label="改寫 DbQueryProvider">改寫 DbQueryProvider</a></li></ul></li><li><a href=#%e6%94%b9%e9%80%b2%e6%ac%84%e7%b6%81%e5%ae%9acolumn-binding aria-label="改進欄綁定(column binding)">改進欄綁定(column binding)</a><ul><li><a href=#%e8%87%aa%e5%ae%9a%e7%be%a9%e7%9a%84-dbexpressiontype aria-label="自定義的 DbExpressionType">自定義的 DbExpressionType</a></li><li><a href=#tableexpression-%e5%af%a6%e4%bd%9c aria-label="TableExpression 實作">TableExpression 實作</a></li><li><a href=#columnexpression-%e5%af%a6%e4%bd%9c aria-label="ColumnExpression 實作">ColumnExpression 實作</a><ul><li><a href=#columndeclaration-%e5%af%a6%e4%bd%9c aria-label="ColumnDeclaration 實作">ColumnDeclaration 實作</a></li></ul></li><li><a href=#selectexpression-%e5%af%a6%e4%bd%9c aria-label="SelectExpression 實作">SelectExpression 實作</a></li><li><a href=#projectionexpression-%e5%af%a6%e4%bd%9c aria-label="ProjectionExpression 實作">ProjectionExpression 實作</a></li><li><a href=#dbexpressionvisitor-%e5%af%a6%e4%bd%9c aria-label="DbExpressionVisitor 實作">DbExpressionVisitor 實作</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=可重複使用的-iqueryable-基類>可重複使用的 IQueryable 基類<a hidden class=anchor aria-hidden=true href=#可重複使用的-iqueryable-基類>#</a></h1><h2 id=iqueryable-簡介>IQueryable 簡介<a hidden class=anchor aria-hidden=true href=#iqueryable-簡介>#</a></h2><p>　　在 C# 最新版本中的 <code>IQueryable</code> 已經不再是一個介面，而是分為兩個部分： <code>IQueryable</code> 與 <code>IQueryProvider</code>。在開始實作之前，我們必須先了解一下這兩個介面。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IQuerable</span> : IEnumerable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Type ElementType { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    Expression Expression { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>    IQueryProvider Provider { <span style=color:#66d9ef>get</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IQueryable</span>&lt;T&gt; : IEnumerable&lt;T&gt;, IQueryable, IEnumerable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　<code>IQueryable</code> 有三個唯讀屬性：</p><ol><li><code>ElementType</code> 代表了元素的類型 (或等於 <code>IQueryable&lt;T></code> 中的 <code>T</code>)</li><li><code>Expression</code> 代表了查詢對應的表達式。這是 <code>IQueryable</code> 存在的核心要素。在 <code>IQueryable</code> 的內部，實際上是一個表示查詢的表達式，它將查詢表示為 LINQ 查詢運算子/方法調用的樹狀結構。如果進一步看，你會發現，<code>IQueryable</code> 或是 <code>Queryable</code> 都只是在提供一個自動構建表達式樹節點 (expression tree nodes) 的機制。當我們對 <code>IQeuryable</code> 使用 <code>Where</code> 方法時，它只是回傳一個新的 <code>IQueryable</code>，並且在進行調用的樹頂添加一個方法表達式樹節點。</li><li><code>Provider</code> 作為真正的「提供者」，它負責原先所有 <code>IQueryable</code> 的執行方法。</li></ol><h2 id=iqueryprovider-簡介>IQueryProvider 簡介<a hidden class=anchor aria-hidden=true href=#iqueryprovider-簡介>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IQueryProvider</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    IQueryable CreateQuery(Expression expression);
</span></span><span style=display:flex><span>    IQueryable&lt;TElement&gt; CreateQuery&lt;TElement&gt;(Expression expression);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>object</span> Execute(Expression expression);
</span></span><span style=display:flex><span>    TResult Execute&lt;TResult&gt;(Expression expression);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　當我們進一步觀察 <code>IQueryProvider</code>，會發現它事實上只有兩個操作：<code>CreateQuery</code>、<code>Execute</code>，只是各有一個泛型與非泛型的方法。一般我們會使用泛型的方法，因為它可以避免使用反射來建構實例，從而提高性能。</p><ol><li><code>CreateQuery</code> 人如其名，它基於指定的表達樹建構 <code>IQueryable</code> 的實例。標準查詢運算子 <code>Queryable</code> 會使用這個方法來建構與 Provider 相關聯的新的 <code>IQueryable</code>。<ul><li>需注意，使用者可以任意向 API 傳遞任何可能的表達樹，甚至不是合法的查詢，然而，它的回傳值必定要是 <code>IQueryable</code>。</li></ul></li><li><code>Execute</code> 是進入 Provider 的入口，用於實際執行查詢表達式。擁有一個明確的執行方法而不僅僅依賴於 <code>IEnumerable.GetEnumerator()</code> 是非常重要的，因為它允許執行時不一定要產生序列。比方說，<code>myquery.Count()</code> 回傳一個整數，該查詢的表達樹是調用一個 Count 方法並回傳整數，其它的聚合方法也是同樣的道理，都是即時的執行方法。</li></ol><h2 id=query-實作-iqueryable>Query 實作 IQueryable<a hidden class=anchor aria-hidden=true href=#query-實作-iqueryable>#</a></h2><p>　　首先，我們從 <code>IQueryable</code> 開始，因為現在這個介面被分為兩個部分，所以我們可以只實現 <code>IQueryable</code> 一次，並在其它的 <code>QueryProvider</code> 中重複使用它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Query</span>&lt;T&gt; : IQueryable&lt;T&gt;, IQueryable, IEnumerable&lt;T&gt;, IEnumerable, IOrderedQueryable&lt;T&gt;, IOrderedQueryable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    QueryProvider provider;
</span></span><span style=display:flex><span>    Expression expression;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Query(QueryProvider provider)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (provider == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentNullException(<span style=color:#e6db74>&#34;provider&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.provider = provider;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.expression = Expression.Constant(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Query(QueryProvider provider, Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (provider == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentNullException(<span style=color:#e6db74>&#34;provider&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (expression == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentNullException(<span style=color:#e6db74>&#34;expression&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (!<span style=color:#66d9ef>typeof</span>(IQueryable&lt;T&gt;).IsAssignableFrom(expression.Type))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ArgumentOutOfRangeException(<span style=color:#e6db74>&#34;expression&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.provider = provider;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.expression = expression;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Expression IQueryable.Expression
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.expression; }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Type IQueryable.ElementType
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>typeof</span>(T); }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IQueryProvider IQueryable.Provider
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.provider; }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IEnumerator&lt;T&gt; GetEnumerator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ((IEnumerable&lt;T&gt;)<span style=color:#66d9ef>this</span>.provider.Execute(<span style=color:#66d9ef>this</span>.expression)).GetEnumerator();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IEnumerator IEnumerable.GetEnumerator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ((IEnumerable)<span style=color:#66d9ef>this</span>.provider.Execute(<span style=color:#66d9ef>this</span>.expression)).GetEnumerator(); 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>string</span> ToString()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.provider.GetQueryText(<span style=color:#66d9ef>this</span>.expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　如你所見，上面的 <code>Query</code> 只用來保存一個 <code>Expression</code> 與一個 <code>Provider</code>。Provider才是真正核心的地方。</p><h2 id=queryprovider-實作-iqueryprovider>QueryProvider 實作 IQueryProvider<a hidden class=anchor aria-hidden=true href=#queryprovider-實作-iqueryprovider>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QueryProvider</span> : IQueryProvider
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> QueryProvider()
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        IQueryable&lt;S&gt; IQueryProvider.CreateQuery&lt;S&gt;(Expression expression)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Query&lt;S&gt;(<span style=color:#66d9ef>this</span>, expression);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		IQueryable IQueryProvider.CreateQuery(Expression expression)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			Type elementType = TypeManager.GetElementType(expression.Type);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>try</span>
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> (IQueryable)Activator.CreateInstance(<span style=color:#66d9ef>typeof</span>(Query&lt;&gt;).MakeGenericType(elementType), <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>object</span>[] { <span style=color:#66d9ef>this</span>, expression });
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>catch</span> (Exception tie)
</span></span><span style=display:flex><span>			{
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>throw</span> tie.InnerException;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		S IQueryProvider.Execute&lt;S&gt;(Expression expression)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> (S)<span style=color:#66d9ef>this</span>.Execute(expression);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>object</span> IQueryProvider.Execute(Expression expression)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.Execute(expression);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>string</span> GetQueryText(Expression expression);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>object</span> Execute(Expression expression);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>　　我們先是用 <code>QueryProvider</code> 實作了 <code>IQueryProvider</code> 的基類別。這些 <code>CreateQuery</code> 方法創建了 <code>Query&lt;T></code> 的新實例，並將執行轉發到尚未實作的 <code>Execute</code> 方法。<br>　　接下來我們可以將之視為樣板，只是為了開始建立一個 LINQ 的 <code>IQueryable</code> 的 provider。真正的執行將會發生在 <code>Execute</code> 的內部，屆時，provider 可以真正通過檢查表達樹來理解查詢的含義。</p><h2 id=helper-typemanager>[Helper] TypeManager<a hidden class=anchor aria-hidden=true href=#helper-typemanager>#</a></h2><p>　　TypeManager 用來處理非泛型的方法，檢查其型別。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TypeManager</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>static</span> Type GetElementType(Type seqType)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Type? ienum = FindIEnumerable(seqType);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ienum == <span style=color:#66d9ef>null</span>) <span style=color:#66d9ef>return</span> seqType;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ienum.GetGenericArguments()[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Type? FindIEnumerable(Type seqType)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (seqType == <span style=color:#66d9ef>null</span> || seqType == <span style=color:#66d9ef>typeof</span>(<span style=color:#66d9ef>string</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (seqType.IsArray)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>typeof</span>(IEnumerable&lt;&gt;).MakeGenericType(seqType.GetElementType());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (seqType.IsGenericType)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> (Type arg <span style=color:#66d9ef>in</span> seqType.GetGenericArguments())
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Type ienum = <span style=color:#66d9ef>typeof</span>(IEnumerable&lt;&gt;).MakeGenericType(arg);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (ienum.IsAssignableFrom(seqType))
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> ienum;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Type[] ifaces = seqType.GetInterfaces();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ifaces != <span style=color:#66d9ef>null</span> &amp;&amp; ifaces.Length &gt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> (Type iface <span style=color:#66d9ef>in</span> ifaces)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Type? ienum = FindIEnumerable(iface);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (ienum != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> ienum;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (seqType.BaseType != <span style=color:#66d9ef>null</span> &amp;&amp; seqType.BaseType != <span style=color:#66d9ef>typeof</span>(<span style=color:#66d9ef>object</span>) )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> FindIEnumerable(seqType.BaseType);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=where-和可重複使用的表達樹詢問器-expression-tree-visitor>Where 和可重複使用的表達樹詢問器 (Expression tree visitor)<a hidden class=anchor aria-hidden=true href=#where-和可重複使用的表達樹詢問器-expression-tree-visitor>#</a></h1><p>　　在建立好基類別 <code>Query</code> 與 <code>QueryProvider</code> 後，我們將繼續建立一個實際執行某些操作的 provider。Query Provider 實際上執行的是一小最被定義為表達樹的程式碼，而不是 IL。當然，它不需要傳統意義上的方式執行它，例如 LINQ to SQL 將查詢表達式轉換為 SQL，並將其發送到伺服器上執行。<br>　　接下來的範例將會舉 LINQ to SQL 很相近，它會將查詢翻譯並執行到一個 ADO provider。在此，我們只打算處理 <code>Where</code> 這個操作，不會做其它更複雜的判斷。將來可能會對它進行擴展，但目前僅為了說明目的。<br>　　要注意 provider 必須要做到兩件事：</p><ol><li>將查詢轉換成 SQL。</li><li>將執行命令的結果轉換成物件。</li></ol><h2 id=查詢翻譯器-query-translator>查詢翻譯器 (Query Translator)<a hidden class=anchor aria-hidden=true href=#查詢翻譯器-query-translator>#</a></h2><p>　　查詢翻譯器將簡單地訪問表達樹中的每個節點，並使用 StringBuilder 將操作轉換成文本。為了說明方便，我們在這裡假設有個 <code>ExpressionVisitor</code> 類，為表達樹節點定義了基本的訪問者模式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QueryTranslator</span> : ExpressionVisitor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    StringBuilder sb;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> QueryTranslator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Translate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        sb = <span style=color:#66d9ef>new</span> StringBuilder();
</span></span><span style=display:flex><span>        Visit(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sb.ToString();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Expression StripQuotes(Expression e)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (e.NodeType == ExpressionType.Quote)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            e = ((UnaryExpression)e).Operand;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> e;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitMethodCall(MethodCallExpression m)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (m.Method.DeclaringType == <span style=color:#66d9ef>typeof</span>(Queryable) &amp;&amp; m.Method.Name == <span style=color:#e6db74>&#34;Where&#34;</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            sb.Append(<span style=color:#e6db74>&#34;Select * From (&#34;</span>);
</span></span><span style=display:flex><span>            Visit(m.Arguments[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>            sb.Append(<span style=color:#e6db74>&#34;) As T Where &#34;</span>);
</span></span><span style=display:flex><span>            LambdaExpression lambda = (LambdaExpression)StripQuotes(m.Arguments[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>            Visit(lambda.Body);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> m;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;The method &#39;{0}&#39; is not supported&#34;</span>, m.Method.Name));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitUnary(UnaryExpression u)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (u.NodeType)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Not:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; Not &#34;</span>);
</span></span><span style=display:flex><span>                Visit(u.Operand);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;The unary operator &#39;{0}&#39; is not supported&#34;</span>, u.NodeType));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> u;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitBinary(BinaryExpression b)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        sb.Append(<span style=color:#e6db74>&#34;(&#34;</span>);
</span></span><span style=display:flex><span>        Visit(b.Left);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (b.NodeType)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Add:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; And &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Or:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; Or &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Equal:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; = &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.NotEqual:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; &lt;&gt; &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.LessThan:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; &lt; &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.LessThanOrEqual:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; &lt;= &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.GreaterThan:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; &gt; &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.GreaterThanOrEqual:
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; &gt;= &#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;The binary operator &#39;{0}&#39; is not supported&#34;</span>, b.NodeType));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        Visit(b.Right);
</span></span><span style=display:flex><span>        sb.Append(<span style=color:#e6db74>&#34;)&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitConstant(ConstantExpression c)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IQueryable? q = c.Value <span style=color:#66d9ef>as</span> IQueryable;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (q != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            sb.Append(<span style=color:#e6db74>&#34;Select * From &#34;</span>);
</span></span><span style=display:flex><span>            sb.Append(q.ElementType.Name);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (c.Value == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            sb.Append(<span style=color:#e6db74>&#34;Null&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> (Type.GetTypeCode(c.Value.GetType()))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> TypeCode.Boolean:
</span></span><span style=display:flex><span>                    sb.Append(((<span style=color:#66d9ef>bool</span>)c.Value) ? <span style=color:#ae81ff>1</span> : <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> TypeCode.String:
</span></span><span style=display:flex><span>                    sb.Append(<span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>                    sb.Append(c.Value);
</span></span><span style=display:flex><span>                    sb.Append(<span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> TypeCode.Object:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;The constant for &#39;{0}&#39; is not supported&#34;</span>, c.Value));
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                    sb.Append(c.Value);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> c;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitMemberAccess(MemberExpression m)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (m.Expression != <span style=color:#66d9ef>null</span> &amp;&amp; m.Expression.NodeType == ExpressionType.Parameter)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            sb.Append(m.Member.Name);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> m;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;The member &#39;{0}&#39; is not supported&#34;</span>, m.Member.Name))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　儘管我們只針對 <code>Where</code> 進行了實作，但仍然相當的複雜。我希望在表達樹中看到的是一個方法的調用，其中參數引用了資料源(source, arg[0])，與謂詞(predicate, arg[1])。參考 <code>VisitMethodCall</code> 方法，我們明確地處理了 <code>Queryable.Where</code> 方法，生成一個 <code>"Select * From ("</code> 的字串，然後遞迴訪問資料源後，加上了 <code>) As T Where</code>，最後再訪問謂詞。這樣可以用嵌套的方式處理資料源中可能出現子查詢的可能。在不考慮其它操作子的情況下，我們可以很優雅的處理 <code>Where</code> 方法。在此表的別名是無關的，因為我們並無對它做任何引用，當然在一個完善的 provider，將有可能對它進行引用。<br>　　這裡包含了一個 helper <code>StripQuotes</code>，它的作用是去除方法參數中的任何 <code>ExpressionType.Quote</code> 節點，以便取得純粹的 lambda 表達式。<br>　　<code>VisitUnary</code> 和 <code>VisitBinary</code> 方法很直白，它們將一元與二元運算子翻譯成文本。<br>　　<code>VisitConstant</code>，在我們的架構中，我們的源引用(table reference)其實就是 <code>IQueryable</code> 的根。如果有一個常數根作為 <code>Query&lt;T></code> 實例，那麼我們可以假設它代表源引用(子查詢)，所以我們可以用 <code>"Select * From"</code> 與查詢元素類型的名稱(ElementType.Name)，即表的名稱。至於其它的常數節點，就是簡單的實際常數，對文本需要以加上單引號。注意，<strong>在此並無處理 SQL injection</strong>，真正的 provider 需要處理這一部分。<br>　　最後，<code>VisitMemberAccess</code> 假設所有的欄位或屬性存取都是指令文字中的欄位參考。在這裡省略了證明，並假設欄位或屬性的名稱與資料庫中的欄位名稱相符。<br>　　給定一個 <code>Product</code> 類別，其欄位與 <code>All_product</code> 資料庫中的欄位名稱相符，此查詢轉譯器將生成以下形式的查詢：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Query&lt;Product&gt; products = ...;
</span></span><span style=display:flex><span>IQueryable&lt;Product&gt; q = products.Where(p =&gt; p.Generation = <span style=color:#e6db74>&#34;L22&#34;</span>);
</span></span></code></pre></div><p>　　對應的 SQL 語句：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>From</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>From</span> Customers
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>As</span> T <span style=color:#66d9ef>Where</span> (Generation <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;L22&#39;</span>)
</span></span></code></pre></div><h2 id=物件閱讀器-object-reader>物件閱讀器 (Object Reader)<a hidden class=anchor aria-hidden=true href=#物件閱讀器-object-reader>#</a></h2><p>　　物件閱讀器的工作是將 SQL 查詢的結果轉換為物件。這裡會建立一個簡單的類別，在建構子中會需要一個 <code>DbDataReader</code>，並且接受一個泛型類型 T 以繼承 <code>IEnumerable&lt;T></code>。實作的部分也沒有什麼花俏的，只能透過射將數據寫入類別的 fields 中，所以需要注意的只有 field 的名稱需要跟 reader 中的欄位名稱相符、類型也必須要相符。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ObjectReader</span>&lt;T&gt; : IEnumerable&lt;T&gt;, IEnumerable <span style=color:#66d9ef>where</span> T : class, <span style=color:#66d9ef>new</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Enumerator? enumerator;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ObjectReader(DbDataReader reader)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        enumerator = <span style=color:#66d9ef>new</span> Enumerator(reader);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IEnumerator&lt;T&gt; GetEnumerator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Enumerator? e = enumerator;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (e == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidOperationException(<span style=color:#e6db74>&#34;Cannot enumerate more than once&#34;</span>);
</span></span><span style=display:flex><span>        enumerator = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> e;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    IEnumerator IEnumerable.GetEnumerator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> GetEnumerator();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Enumerator</span> : IEnumerator&lt;T&gt;, IEnumerator, IDisposable
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        DbDataReader reader;
</span></span><span style=display:flex><span>        FieldInfo[] fields;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span>[] fieldLookup;
</span></span><span style=display:flex><span>        T current;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>internal</span> Enumerator(DbDataReader reader)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.reader = reader;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.fields = <span style=color:#66d9ef>typeof</span>(T).GetFields();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> T Current =&gt; current;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>object</span> IEnumerator.Current =&gt; current;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> MoveNext()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (reader.Read())
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (fieldLookup == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    InitFieldLookup();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                T instance = <span style=color:#66d9ef>new</span> T();
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>, n = fields.Length; i &lt; n; i++)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> index = fieldLookup[i];
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (index &gt;= <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        FieldInfo fi = fields[i];
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (reader.IsDBNull(index))
</span></span><span style=display:flex><span>                        {
</span></span><span style=display:flex><span>                            fi.SetValue(instance, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        {
</span></span><span style=display:flex><span>                            fi.SetValue(instance, reader.GetValue(index));
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                current = instance;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Reset()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Dispose()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            reader.Dispose();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> InitFieldLookup()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> map = <span style=color:#66d9ef>new</span> Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>int</span>&gt;(StringComparer.InvariantCultureIgnoreCase);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>, n = reader.FieldCount; i &lt; n; i++)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                map.Add(reader.GetName(i), i);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            fieldLookup = <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>int</span>[fields.Length];
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>, n = fields.Length; i &lt; n; i++)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (map.TryGetValue(fields[i].Name, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>int</span> index))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    fieldLookup[i] = index;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    fieldLookup[i] = -<span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　<code>ObjectReader</code> 為每一行由 <code>DbDataReader</code> 讀取的類型 <code>T</code> 創建一個新的實例。它使用反射 API <code>FieldInfo.SetValue</code> 為對象物件的每個 field 分配值。當 <code>ObjectReader</code> 首次創建時，它實例化嵌套的 <code>Enumerator</code> 類的實例。當調用 <code>GetEnumerator</code> 方法時，將分發此枚舉器。由於 <code>DataReader</code> 無法重置並再次執行，因此枚舉器只能分發一次。如果第二次調用 <code>GetEnumerator</code>，則會拋出異常。<br>　　<code>ObjectReader</code> 在 field 上的排序是寬鬆的。由於 <code>QueryTranslator</code> 使用了 <code>Select *</code> 建構查詢，這是必須的，否則程式無法知道結果中哪個欄位會首先出現。注意，一般程式中不建議使用 <code>Select *</code>。為了允許不同欄的順序，在讀取 <code>DataReader</code> 的第一行時，精確的順序會在執行期被定義。<code>InitFieldLookup</code> 方法構建了一個從欄位名稱對欄位索引對映射，並組裝了一個查找表 <code>fieldLookup</code>，用於將物件的 fields 與索引進行映射。</p><h2 id=提供者-provider>提供者 (Provider)<a hidden class=anchor aria-hidden=true href=#提供者-provider>#</a></h2><p>　　現在我們已經有了 <code>IQueryable</code> 與 <code>QueryProvider</code> 的基礎建設，要將它們結合在一起製作一個實際的 <code>IQueryable</code> LINQ Provider 就很容易了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DbQueryProvider</span> : QueryProvider
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> DbConnection connection; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DbQueryProvider(DbConnection connection)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.connection = connection;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>string</span> GetQueryText(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Translate(expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>object</span> Execute(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        DbCommand cmd = connection.CreateCommand();
</span></span><span style=display:flex><span>        cmd.CommandText = Translate(expression);
</span></span><span style=display:flex><span>        DbDataReader reader = cmd.ExecuteReader();
</span></span><span style=display:flex><span>        Type elementType = TypeManager.GetElementType(expression.Type);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Activator.CreateInstance(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>typeof</span>(ObjectReader&lt;&gt;).MakeGenericType(elementType),
</span></span><span style=display:flex><span>            BindingFlags.Instance | BindingFlags.NonPublic, <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>object</span>[] { reader },
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>string</span> Translate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QueryTranslator().Translate(expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=try-it-out>Try it out<a hidden class=anchor aria-hidden=true href=#try-it-out>#</a></h2><p>現在有了 provider，我們可以按照 LINQ to SQL 模型進行操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Customers</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> CustomerId;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> ContactName;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Phone;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> City;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Country;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Orders</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> OrderId;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> CustomerId;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DateTime OrderDate;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Northwind</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Query&lt;Customers&gt; Customers;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Query&lt;Orders&gt; Orders;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Northwind(DbConnection connection)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        QueryProvider provider = <span style=color:#66d9ef>new</span> DbQueryProvider(connection);
</span></span><span style=display:flex><span>        Customers = <span style=color:#66d9ef>new</span> Query&lt;Customers&gt;(provider);
</span></span><span style=display:flex><span>        Orders = <span style=color:#66d9ef>new</span> Query&lt;Orders&gt;(provider);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Program</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> Main(<span style=color:#66d9ef>string</span>[] args)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>string</span> connstr = <span style=color:#e6db74>@&#34;...&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>var</span> conn = <span style=color:#66d9ef>new</span> SqlConnection(connstr))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            conn.Open();
</span></span><span style=display:flex><span>            Northwind db = <span style=color:#66d9ef>new</span> Northwind(conn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            IQueryable&lt;Customers&gt; query = 
</span></span><span style=display:flex><span>                db.Customers.Where(c =&gt; c.City == <span style=color:#e6db74>&#34;London&#34;</span>);
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            Console.WriteLine(<span style=color:#e6db74>&#34;Query:\n{0}\n&#34;</span>, query);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> list = query.ToList();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>foreach</span> (<span style=color:#66d9ef>var</span> item <span style=color:#66d9ef>in</span> list)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#e6db74>&#34;Name: {0}&#34;</span>, item.ContactName);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Console.ReadLine();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=helper-表達式訪問者-expression-visitor>[Helper] 表達式訪問者 (Expression Visitor)<a hidden class=anchor aria-hidden=true href=#helper-表達式訪問者-expression-visitor>#</a></h2><p>　　這個表達式訪問者是一種訪問者模式的呈現。在這個變體中，只有一個訪問者類別，將調用分派到對應於不同節點類型的特定 <code>VisitXXX</code> 方法的一般訪問函數。注意，並非每個節點類型都有自己的方法，例如所有二元運算子都在一個 <code>VisitBinary</code> 方法中處理。節點本身不直接參與訪問的過程，它們只被視為數據。這樣做的原因是訪問者的數量實際上是開放的。因此，訪問的語義並未耦合到節點類別中，而是完全由訪問者控制。節點的默認訪問行為已經內置在基類的 <code>VisitXXX</code> 版本中了。<br>　　另一個變體是所有 <code>VisitXXX</code> 方法都返回一個節點。樹節點是不可變的，為了改變樹，必須要構建一個新的樹。如果任何子樹發生變化，默認的 <code>VisitXXX</code> 方法將構建一個新的節點。如果沒有進行任何更改，則返回相同的節點。這樣，如果在樹的深處進行了一個更改，則整個樹將自動重新構建。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExpressionVisitor</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> ExpressionVisitor()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression Visit(Expression exp)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (exp == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> exp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (exp.NodeType)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Negate:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.NegateChecked:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Not:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Convert:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.ConvertChecked:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.ArrayLength:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Quote:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.TypeAs:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitUnary((UnaryExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Add:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.AddChecked:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Subtract:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.SubtractChecked:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Multiply:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.MultiplyChecked:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Divide:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Modulo:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.And:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.AndAlso:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Or:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.OrElse:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.LessThan:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.LessThanOrEqual:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.GreaterThan:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.GreaterThanOrEqual:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Equal:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.NotEqual:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Coalesce:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.ArrayIndex:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.RightShift:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.LeftShift:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.ExclusiveOr:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitBinary((BinaryExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.TypeIs:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitTypeIs((TypeBinaryExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Conditional:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitConditional((ConditionalExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Constant:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitConstant((ConstantExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Parameter:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitParameter((ParameterExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.MemberAccess:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitMemberAccess((MemberExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Call:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitMethodCall((MethodCallExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Lambda:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitLambda((LambdaExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.New:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitNew((NewExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.NewArrayInit:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.NewArrayBounds:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitNewArray((NewArrayExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.Invoke:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitInvocation((InvocationExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.MemberInit:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitMemberInit((MemberInitExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ExpressionType.ListInit:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitListInit((ListInitExpression)exp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Exception(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;Unhandled expression type: &#39;{0}&#39;&#34;</span>, exp.NodeType));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> MemberBinding VisitBinding(MemberBinding binding)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (binding.BindingType)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MemberBindingType.Assignment:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitMemberAssignment((MemberAssignment)binding);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MemberBindingType.MemberBinding:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitMemberMemberBinding((MemberMemberBinding)binding);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> MemberBindingType.ListBinding:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.VisitMemberListBinding((MemberListBinding)binding);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Exception(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;Unhandled binding type &#39;{0}&#39;&#34;</span>, binding.BindingType));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> ElementInit VisitElementInitializer(ElementInit initializer)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        ReadOnlyCollection&lt;Expression&gt; arguments = <span style=color:#66d9ef>this</span>.VisitExpressionList(initializer.Arguments);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (arguments != initializer.Arguments)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.ElementInit(initializer.AddMethod, arguments);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> initializer;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitUnary(UnaryExpression u)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression operand = <span style=color:#66d9ef>this</span>.Visit(u.Operand);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (operand != u.Operand)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.MakeUnary(u.NodeType, operand, u.Type, u.Method);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> u;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitBinary(BinaryExpression b)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression left = <span style=color:#66d9ef>this</span>.Visit(b.Left);
</span></span><span style=display:flex><span>        Expression right = <span style=color:#66d9ef>this</span>.Visit(b.Right);
</span></span><span style=display:flex><span>        Expression conversion = <span style=color:#66d9ef>this</span>.Visit(b.Conversion);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (left != b.Left || right != b.Right || conversion != b.Conversion)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (b.NodeType == ExpressionType.Coalesce &amp;&amp; b.Conversion != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Expression.Coalesce(left, right, conversion <span style=color:#66d9ef>as</span> LambdaExpression);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Expression.MakeBinary(b.NodeType, left, right, b.IsLiftedToNull, b.Method);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitTypeIs(TypeBinaryExpression b)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression expr = <span style=color:#66d9ef>this</span>.Visit(b.Expression);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (expr != b.Expression)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.TypeIs(expr, b.TypeOperand);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitConstant(ConstantExpression c)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> c;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitConditional(ConditionalExpression c)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression test = <span style=color:#66d9ef>this</span>.Visit(c.Test);
</span></span><span style=display:flex><span>        Expression ifTrue = <span style=color:#66d9ef>this</span>.Visit(c.IfTrue);
</span></span><span style=display:flex><span>        Expression ifFalse = <span style=color:#66d9ef>this</span>.Visit(c.IfFalse);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (test != c.Test || ifTrue != c.IfTrue || ifFalse != c.IfFalse)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.Condition(test, ifTrue, ifFalse);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> c;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitParameter(ParameterExpression p)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> p;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitMemberAccess(MemberExpression m)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression exp = <span style=color:#66d9ef>this</span>.Visit(m.Expression);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (exp != m.Expression)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.MakeMemberAccess(exp, m.Member);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> m;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitMethodCall(MethodCallExpression m)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression obj = <span style=color:#66d9ef>this</span>.Visit(m.Object);
</span></span><span style=display:flex><span>        IEnumerable&lt;Expression&gt; args = <span style=color:#66d9ef>this</span>.VisitExpressionList(m.Arguments);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (obj != m.Object || args != m.Arguments)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.Call(obj, m.Method, args);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> m;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> ReadOnlyCollection&lt;Expression&gt; VisitExpressionList(ReadOnlyCollection&lt;Expression&gt; original)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        List&lt;Expression&gt; list = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>, n = original.Count; i &lt; n; i++)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Expression p = <span style=color:#66d9ef>this</span>.Visit(original[i]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (list != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                list.Add(p);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (p != original[i])
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                list = <span style=color:#66d9ef>new</span> List&lt;Expression&gt;(n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j = <span style=color:#ae81ff>0</span>; j &lt; i; j++)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    list.Add(original[j]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                list.Add(p);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (list != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> list.AsReadOnly();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> original;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> MemberAssignment VisitMemberAssignment(MemberAssignment assignment)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression e = <span style=color:#66d9ef>this</span>.Visit(assignment.Expression);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (e != assignment.Expression)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.Bind(assignment.Member, e);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> assignment;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> MemberMemberBinding VisitMemberMemberBinding(MemberMemberBinding binding)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IEnumerable&lt;MemberBinding&gt; bindings = <span style=color:#66d9ef>this</span>.VisitBindingList(binding.Bindings);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (bindings != binding.Bindings)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.MemberBind(binding.Member, bindings);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> binding;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> MemberListBinding VisitMemberListBinding(MemberListBinding binding)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IEnumerable&lt;ElementInit&gt; initializers = <span style=color:#66d9ef>this</span>.VisitElementInitializerList(binding.Initializers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (initializers != binding.Initializers)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.ListBind(binding.Member, initializers);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> binding;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> IEnumerable&lt;MemberBinding&gt; VisitBindingList(ReadOnlyCollection&lt;MemberBinding&gt; original)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        List&lt;MemberBinding&gt; list = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>, n = original.Count; i &lt; n; i++)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            MemberBinding b = <span style=color:#66d9ef>this</span>.VisitBinding(original[i]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (list != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                list.Add(b);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (b != original[i])
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                list = <span style=color:#66d9ef>new</span> List&lt;MemberBinding&gt;(n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j = <span style=color:#ae81ff>0</span>; j &lt; i; j++)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    list.Add(original[j]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                list.Add(b);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (list != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> list;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> original;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> IEnumerable&lt;ElementInit&gt; VisitElementInitializerList(ReadOnlyCollection&lt;ElementInit&gt; original)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        List&lt;ElementInit&gt; list = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>, n = original.Count; i &lt; n; i++)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            ElementInit <span style=color:#66d9ef>init</span> = <span style=color:#66d9ef>this</span>.VisitElementInitializer(original[i]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (list != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                list.Add(<span style=color:#66d9ef>init</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>init</span> != original[i])
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                list = <span style=color:#66d9ef>new</span> List&lt;ElementInit&gt;(n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j = <span style=color:#ae81ff>0</span>; j &lt; i; j++)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    list.Add(original[j]);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                list.Add(<span style=color:#66d9ef>init</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (list != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> list;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> original;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitLambda(LambdaExpression lambda)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression body = <span style=color:#66d9ef>this</span>.Visit(lambda.Body);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (body != lambda.Body)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.Lambda(lambda.Type, body, lambda.Parameters);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> lambda;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> NewExpression VisitNew(NewExpression nex)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IEnumerable&lt;Expression&gt; args = <span style=color:#66d9ef>this</span>.VisitExpressionList(nex.Arguments);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (args != nex.Arguments)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (nex.Members != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Expression.New(nex.Constructor, args, nex.Members);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Expression.New(nex.Constructor, args);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> nex;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitMemberInit(MemberInitExpression <span style=color:#66d9ef>init</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        NewExpression n = <span style=color:#66d9ef>this</span>.VisitNew(<span style=color:#66d9ef>init</span>.NewExpression);
</span></span><span style=display:flex><span>        IEnumerable&lt;MemberBinding&gt; bindings = <span style=color:#66d9ef>this</span>.VisitBindingList(<span style=color:#66d9ef>init</span>.Bindings);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (n != <span style=color:#66d9ef>init</span>.NewExpression || bindings != <span style=color:#66d9ef>init</span>.Bindings)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.MemberInit(n, bindings);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>init</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitListInit(ListInitExpression <span style=color:#66d9ef>init</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        NewExpression n = <span style=color:#66d9ef>this</span>.VisitNew(<span style=color:#66d9ef>init</span>.NewExpression);
</span></span><span style=display:flex><span>        IEnumerable&lt;ElementInit&gt; initializers = <span style=color:#66d9ef>this</span>.VisitElementInitializerList(<span style=color:#66d9ef>init</span>.Initializers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (n != <span style=color:#66d9ef>init</span>.NewExpression || initializers != <span style=color:#66d9ef>init</span>.Initializers)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.ListInit(n, initializers);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>init</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitNewArray(NewArrayExpression na)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IEnumerable&lt;Expression&gt; exprs = <span style=color:#66d9ef>this</span>.VisitExpressionList(na.Expressions);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (exprs != na.Expressions)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (na.NodeType == ExpressionType.NewArrayInit)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Expression.NewArrayInit(na.Type.GetElementType(), exprs);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> Expression.NewArrayBounds(na.Type.GetElementType(), exprs);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> na;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitInvocation(InvocationExpression iv)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IEnumerable&lt;Expression&gt; args = <span style=color:#66d9ef>this</span>.VisitExpressionList(iv.Arguments);
</span></span><span style=display:flex><span>        Expression expr = <span style=color:#66d9ef>this</span>.Visit(iv.Expression);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (args != iv.Arguments || expr != iv.Expression)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.Invoke(expr, args);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> iv;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=本地變量參考-local-variable-references>本地變量參考 (Local Variable References)<a hidden class=anchor aria-hidden=true href=#本地變量參考-local-variable-references>#</a></h1><p>　　至此，我們已經建立了一個 provider，但它只能操作一些查詢運算子和一些次要的運算子，例如比較運算子等等。然後，真正的 provider 不得不處理更多運算子與它們之間的複雜操作。</p><h2 id=翻譯本地變數參考-translate-local-variable-references>翻譯本地變數參考 (Translate Local Variable References)<a hidden class=anchor aria-hidden=true href=#翻譯本地變數參考-translate-local-variable-references>#</a></h2><p>　　假如我們需要用參考本地變數的方式來進行參詢，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>string</span> city = <span style=color:#e6db74>&#34;London&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> query = db.Customers.Where(c =&gt; c.City == city);
</span></span></code></pre></div><p>　　在目前的設計會丟出一個異常: <code>The member 'city' is not supported</code>，city 應該是其中一個欄位，不應是 member，所以我們進一步看向表達式樹的 <code>ToString()</code> 所丟出的結果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>Select * From Customers.Where(c =&gt; <span style=color:#66d9ef>return</span> (c.City = <span style=color:#66d9ef>value</span>(Sample.Program+&lt;&gt;c__DisplayClass0).city))
</span></span></code></pre></div><p>　　原來 C# 編譯器已經創建了一個類來保存在 lambda 表達式中被引用的局部變數了。當局部變數在匿名方法中被引用時，它也會做同樣的事情。<br>　　無論如何，如果我們想讓 provider 與本地變數的參考一起工作，我們就必須處理它。也許我們可以只識別這些編譯器生成的類型的 field 引用，那我們該如何識別編譯器生成的類型？根據名稱嗎？如果 C# 編譯器改變了它們命名方式怎麼辦？如果另一種語言使用了不同的方案呢？本地變數是唯一的情況嗎？那麼在範圍內引用成員變數呢？它們也不會被編碼成樹中的值。最好的情況是，它們是一個常數節點，引用該成員所在的實例，或是一個 MemberAccess 的節點，用於訪問該實例上的成員。我們能否只識別對常數節點的任何成員訪問，並使用反射手動評估它？也許可以，但如果編譯器生成了更複雜的東西呢？
　　我們要做的是在整個樹中識別可以立即評估並轉換值的子樹，如果我們能做到這一點，那麼翻譯器的其餘部分只需要處理這些值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Expression PartialEval(Expression expression, Func&lt;Expression, <span style=color:#66d9ef>bool</span>&gt; fnCanBeEvaluated)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SubtreeEvaluator(<span style=color:#66d9ef>new</span> Nominator(fnCanBeEvaluated).Nominate(expression)).Eval(expression);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Expression PartialEval(Expression expression)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> PartialEval(expression, Evaluator.CanBeEvaluatedLocally);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> CanBeEvaluatedLocally(Expression expression)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> expression.NodeType != ExpressionType.Parameter;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SubtreeEvaluator</span> : ExpressionVisitor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    HashSet&lt;Expression&gt; candidates;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> SubtreeEvaluator(HashSet&lt;Expression&gt; candidates)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.candidates = candidates;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> Expression Eval(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Visit(expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression Visit(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (expression == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (candidates.Contains(expression))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Evaluate(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>base</span>.Visit(expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Expression Evaluate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (expression.NodeType == ExpressionType.Constant)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> expression;
</span></span><span style=display:flex><span>        LambdaExpression lambda = Expression.Lambda(expression);
</span></span><span style=display:flex><span>        Delegate fn = lambda.Compile();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Expression.Constant(fn.DynamicInvoke(<span style=color:#66d9ef>null</span>), expression.type);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Nominator</span> : ExpressionVisitor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Func&lt;Expression, <span style=color:#66d9ef>bool</span>&gt; fnCanBeEvaluated;
</span></span><span style=display:flex><span>    HashSet&lt;Expression&gt; candidates;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>bool</span> cannotBeEvaluated;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> Nominator(Func&lt;Expression, <span style=color:#66d9ef>bool</span>&gt; fnCanBeEvaluated)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.fnCanBeEvaluated = fnCanBeEvaluated;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> HashSet&lt;Expression&gt; Nominate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.candidates = <span style=color:#66d9ef>new</span> HashSet&lt;Expression&gt;();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.Visit(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.candidates;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression Visit(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (expression != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>bool</span> saveCannotBeEvaluated = <span style=color:#66d9ef>this</span>.cannotBeEvaluated;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.cannotBeEvaluated = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>base</span>.Visit(expression);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (!<span style=color:#66d9ef>this</span>.cannotBeEvaluated)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.fnCanBeEvaluated(expression))
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.candidates.Add(expression);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> 
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.cannotBeEvaluated = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.cannotBeEvaluated |= saveCannotBeEvaluated;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> expression;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　Evaluator 類公開了一個靜態方法 <code>ParitalEval</code>，讓我們可以呼叫此方法來評估表達式中的子樹，只留下具有實際值的常數節點。<br>　　大部分的程式碼是用來劃分可以獨立求值的最大小樹。實際評估的過程非常簡單，因為這些子樹可以使用 <code>LambdaExpression.Compile</code> 進行編譯，轉換為委派並進行調用。我們可以在 <code>SubtreeVisitor.Evaluate</code> 方法中觀察這一過程的發生。<br>　　確定最大子樹的過程分為兩個步驟，首先，在 <code>Nominator</code> 類中進行自底向上的遍歷，確定可能獨立求值的節點，然後在 <code>SubtreeEvaluator</code> 中進行自頂向下的遍歷，找到被標記的子樹的最高節點。<br>　　Nominator 由我們的定義的函式作參數化，該函數可以使用任何觸發式方法來確定某個給定節點是否可以獨立求值。默認的觸發鉽方法是除了 ExpressionType.Parameter 之外的任何節點都可以獨立求值。除此之外，還有一個通用規則，即如果子節點無法在本地求值，則父節點也無法求值。因此，參數上游的任何節點都無法求值並將保留在樹中。其它所有節點將被求值並替換成常數。<br>　　現在有了這個類別，我們就可以在翻譯表達樹時隨時使用它。這個操作已經被分解到 <code>DbQueryProvider</code> 類別的 <code>Translate</code> 方法中了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DbQueryProvider</span> : QueryProvider
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>string</span> Translate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        expression = Evaluator.PartialEval(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QueryTranslator().Translate(expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=select>Select<a hidden class=anchor aria-hidden=true href=#select>#</a></h1><p>　　我們已經有了一個粗糙的 LINQ provider 了，可以把 <code>Where</code> 方法轉成 SQL。可以執行查詢並將結果轉成我的物件。但我們想要做的是一個可以完整運作的 ORM，首先我們可以試著將 provider 加入 <code>Select</code>。<br>　　相比 <code>Select</code>，翻譯 <code>Where</code> 方法容易許多。我指的是 LINQ 的 Select 操作，我們可以將數據轉換成任何我們想要的形式。LINQ 的 Select 運算子的選擇器函數可以是任何用戶能夠想象的轉換表達式。這裡可能會有物件建構子、初始化程式、條件語句、二元運算子、方法調用等等。我們該如何將這些轉換成 SQL，更不用說在返回的物件中重現這種結構？<br>　　事實上，當用戶撰寫好查詢時，它已經寫好程式碼了。<br>　　選擇器函數是建構結果的程式碼，如果這是物件的 LINQ 而不是 <code>IQueryable</code> 提供的程式，選擇器函數將是運行以產生結果的程式碼，這有什麼不同呢？<br>　　如果選擇器函數是實際程式碼而不是表達樹，那它只需要一個函數將一個物件轉換成另一個物件。
　　我們可能可以將先前的 <code>ObjectReader</code> 與基本上是 LINQ to Objects 版本的 Select 結合起來，將檢索到的所有數據結果轉換為不同形狀。然而，這將是對時間與空間結構的嚴重濫用。我們不應該檢索所有數據，我們只應該帶回需要的二元制結果(bits)。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProjectionRow</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>object</span> GetValue(<span style=color:#66d9ef>int</span> index);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　先做一個簡單的抽象基類，代表一行數據。如果我們透過選擇器表達式通過調用 <code>GetValue</code> 從這個對象中提取數據，然後使用 <code>Expression.Convert</code> 操作。</p><h2 id=columnprojector-實作>ColumnProjector 實作<a hidden class=anchor aria-hidden=true href=#columnprojector-實作>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ColumnProjector</span> : ExpressionVisitor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    StringBuilder sb;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> iColumn;
</span></span><span style=display:flex><span>    ParameterExpression row;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> MethodInfo miGetValue;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> ColumnProjector()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (miGetValue == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            miGetValue = <span style=color:#66d9ef>typeof</span>(ProjectionRow).GetMethod(<span style=color:#e6db74>&#34;GetValue&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> ColumnProjection ProjectColumns(Expression expression, ParameterExpression row)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        sb = <span style=color:#66d9ef>new</span> StringBuilder();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.row = row;
</span></span><span style=display:flex><span>        Expression selector = <span style=color:#66d9ef>this</span>.Visit(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ColumnProjection
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Columns = sb.ToString(),
</span></span><span style=display:flex><span>            Selector = selector
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitMemberAccess(MemberExpression m)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (m.Expression != <span style=color:#66d9ef>null</span> &amp;&amp; m.Expression.NodeType == ExpressionType.Parameter)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (sb.Length &gt; <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34;, &#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            sb.Append(m.Member.Name);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Expression.Convert(Expression.Call(row, miGetValue, Expression.Constant(iColumn++)), m.Type);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>base</span>.VisitMemberAccess(m);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　<code>ColumnProjector</code> 是一個訪問者，它遍歷表達式樹，將欄參考轉換成可以通過調用 <code>GetValue</code> 方法來訪問的個別數據表達式。這個方法來一個叫作 row 的 <code>ParameterExpression</code>，它的類型被定義為 <code>ProjectionRow</code> 抽象類。我不僅正在重建這個選擇器表達式，最終還要將它轉換成一個以 <code>ProjectionRow</code> 為參數的 lambda 表達式主體。這樣我就可以通過調用 <code>LambdaExpression.Compile</code> 方法將 LambdaExpression 轉換為委託。<br>　　注意，訪問者還建立了一個表示 SQL select 子句的字串。現在每當我們在查詢表達式中看到 <code>Queryable.Select</code>，我們都可以將選擇器轉換為同時產生結果的函數，以及下 SQL 需要的 <code>select</code> 子句。</p><h2 id=改寫-querytranslator>改寫 QueryTranslator<a hidden class=anchor aria-hidden=true href=#改寫-querytranslator>#</a></h2><p>　　以下是修改過後的 <code>QueryTranslator</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QueryTranslator</span> : ExpressionVisitor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    StringBuilder sb;
</span></span><span style=display:flex><span>    ParameterExpression row;
</span></span><span style=display:flex><span>    ColumnProjection projection;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> TranslateResult Translate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        sb = <span style=color:#66d9ef>new</span> StringBuilder();
</span></span><span style=display:flex><span>        row = Expression.Parameter(<span style=color:#66d9ef>typeof</span>(ProjectionRow), <span style=color:#e6db74>&#34;row&#34;</span>);
</span></span><span style=display:flex><span>        Visit(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TranslateResult
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            CommandText = sb.ToString(),
</span></span><span style=display:flex><span>            projector = projection != <span style=color:#66d9ef>null</span> ? Expression.Lambda(projection.Selector, row) : <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>override</span> Expression VisitMethodCall(MethodCallExpression m)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (m.Method.DeclaringType == <span style=color:#66d9ef>typeof</span>(Queryable))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (m.Method.Name == <span style=color:#e6db74>&#34;Where&#34;</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34;Select * From (&#34;</span>);
</span></span><span style=display:flex><span>                Visit(m.Arguments[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34;) As T Where &#34;</span>);
</span></span><span style=display:flex><span>                LambdaExpression lambda = (LambdaExpression)StripQuotes(m.Arguments[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>                Visit(lambda.Body);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> m;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (m.Method.Name == <span style=color:#e6db74>&#34;Select&#34;</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                LambdaExpression lambda = (LambdaExpression)StripQuotes(m.Arguments[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>                ColumnProjection proj = <span style=color:#66d9ef>new</span> ColumnProjector().ProjectColumns(lambda.Body, row);
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34;Select &#34;</span>);
</span></span><span style=display:flex><span>                sb.Append(proj.Columns);
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34; From (&#34;</span>);
</span></span><span style=display:flex><span>                Visit(m.Arguments[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>                sb.Append(<span style=color:#e6db74>&#34;) As T &#34;</span>);
</span></span><span style=display:flex><span>                projection = proj;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> m;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> NotSupportedException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;The method &#39;{0}&#39; is not supported&#34;</span>, m.Method.Name));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　其中 <code>TranslateResult</code> 裝載要下的 SQL 字串與 lambda 表達式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TranslateResult</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> CommandText;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> LambdaExpression projector;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　現在 <code>QueryTranslator</code> 處理 Select 方法，就像 Where 方法一樣建構 SQL Select 語句。然而，它還記住了最後一個 ColumnProjection(調用 ProjectColumns 的結果)，並將新重構的選擇器作為 LambdaExpression 反回到 TranslateResult 物件中。<br>　　現在我們所需要的是一個能夠根據這個 LambdaExpression 工作的 ObjectReader，而不僅僅是建構一個物件。</p><h2 id=改寫-projection-reader>改寫 Projection Reader<a hidden class=anchor aria-hidden=true href=#改寫-projection-reader>#</a></h2><p>　　<code>Projection Reader</code> 可以改寫成：</p><pre tabindex=0><code class=language-chsarp data-lang=chsarp>internal class ProjectionReader&lt;T&gt; : IEnumerable&lt;T&gt;, IEnumerable 
{
    Enumerator&lt;T&gt; enumerator;
    internal ProjectionReader(DbDataReader reader, Func&lt;ProjectionRow, T&gt; projector)
    {
        enumerator = new Enumerator&lt;T&gt;(reader, projector);
    }

    public IEnumerator&lt;T&gt; GetEnumerator()
    {
        Enumerator&lt;T&gt; e = enumerator;
        if (e == null)
            throw new InvalidOperationException(&#34;Cannot enumerate more than once&#34;);
        enumerator = null;
        return e;
    }

    IEnumerator IEnumerable.GetEnumerator()
    {
        return GetEnumerator();
    }
}
</code></pre><p>　　其中，<code>Enumerator</code> 的實作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Enumerator</span>&lt;T&gt; : ProjectionRow, IEnumerator&lt;T&gt;, IEnumerator, IDisposable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    DbDataReader reader;
</span></span><span style=display:flex><span>    T current;
</span></span><span style=display:flex><span>    Func&lt;ProjectionRow, T&gt; projector;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> Enumerator(DbDataReader reader, Func&lt;ProjectionRow, T&gt; projector)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.reader = reader;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.projector = projector;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>object</span> GetValue(<span style=color:#66d9ef>int</span> index)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (index &gt;= <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (reader.IsDBNull(index))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> reader.GetValue(index);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IndexOutOfRangeException();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> T Current
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> current; }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>object</span> IEnumerator.Current
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>get</span> { <span style=color:#66d9ef>return</span> current; }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> MoveNext()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (reader.Read())
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            current = projector(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Reset()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Dispose()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        reader.Dispose();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　<code>ProjectionReader</code> 類別與 <code>ObjectReader</code> 類別幾乎相同，唯一的差異在於缺少根據欄位建構物件的邏輯。取而代之的是對這個新的 <strong>projector</strong> 委派的呼叫。這個想法是，將我們可以重建的選擇器表達式中獲得完全相同的委派。<br>　　所以，我們重新建立了選擇器表達式，以引用一個類型為 <code>ProjectionRow</code> 的參數。現在我們可以看到 <code>ProjectionReader</code> 內部的 <code>Enumerator</code> 類別實現了這個 <code>ProjectionRow</code>。它是唯一可以引用 <code>DbDataReader</code> 的物件，這也讓我們在調用時能夠輕鬆地將 <code>this</code> 傳遞給委派。</p><h2 id=改寫-dbqueryprovider>改寫 DbQueryProvider<a hidden class=anchor aria-hidden=true href=#改寫-dbqueryprovider>#</a></h2><p>　　有了這些，我們可以構建新的 provider：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DbQueryProvider</span> : QueryProvider
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> DbConnection connection; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DbQueryProvider(DbConnection connection)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.connection = connection;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>string</span> GetQueryText(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Translate(expression).CommandText;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>object</span> Execute(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        TranslateResult result = Translate(expression);
</span></span><span style=display:flex><span>        DbCommand cmd = connection.CreateCommand();
</span></span><span style=display:flex><span>        cmd.CommandText = result.CommandText;
</span></span><span style=display:flex><span>        DbDataReader reader = cmd.ExecuteReader();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Type elementType = TypeManager.GetElementType(expression.Type);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (result.projector != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Delegate projector = result.projector.Compile();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Activator.CreateInstance(
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>typeof</span>(ProjectionReader&lt;&gt;).MakeGenericType(elementType),
</span></span><span style=display:flex><span>                BindingFlags.Instance | BindingFlags.NonPublic, <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>object</span>[] { reader, projector },
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Activator.CreateInstance(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>typeof</span>(ObjectReader&lt;&gt;).MakeGenericType(elementType),
</span></span><span style=display:flex><span>            BindingFlags.Instance | BindingFlags.NonPublic, <span style=color:#66d9ef>null</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>object</span>[] { reader },
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> TranslateResult Translate(Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        expression = Evaluator.PartialEval(expression);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> QueryTranslator().Translate(expression);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　調用 <code>Translate</code> 方法會返回我們所需的一切。我們只需要通過調用 <code>Compile</code> 將 LambdaExpression 轉換成委託。注意，我們仍然需要保留舊的 <code>ObjectReader</code>。這只是為了防止查詢從未出來 Select 的情況。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>string</span> city = <span style=color:#e6db74>&#34;London&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> query = db.Customers
</span></span><span style=display:flex><span>                .Where(c =&gt; c.City == city)
</span></span><span style=display:flex><span>                .Select(c =&gt; <span style=color:#66d9ef>new</span> 
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    Name = c.ContactName,
</span></span><span style=display:flex><span>                    Phone = c.Phone
</span></span><span style=display:flex><span>                });
</span></span></code></pre></div><p>　　現在上面的查詢語句已經可以執行了。以下是產生的結果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>Select</span> ContactName, Phone <span style=color:#66d9ef>From</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>From</span> (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>From</span> Customers
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>As</span> T <span style=color:#66d9ef>Where</span> (
</span></span><span style=display:flex><span>        City <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;London&#39;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>As</span> T
</span></span></code></pre></div><h1 id=改進欄綁定column-binding>改進欄綁定(column binding)<a hidden class=anchor aria-hidden=true href=#改進欄綁定column-binding>#</a></h1><p>　　我們已經構建了一個可以工作的 LINQ IQueryable provider，它針對 ADO 和 SQL，並且到目前為止已經能夠翻譯 <code>Queryable.Where</code> 和 <code>Queryable.Select</code> 標準查詢運算子。然後還存在很大的缺失，不只是缺少了運算子如 <code>OrderBy</code> 與 <code>Join</code>，而是更大的概念性錯誤。<br>　　嘗試重新調換 <code>.Where</code> 與 <code>.Select</code> 的順序：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> query = db.Customers.Select(c =&gt; <span style=color:#66d9ef>new</span> {
</span></span><span style=display:flex><span>                            Name = c.ContactName,
</span></span><span style=display:flex><span>                            Location = c.City
</span></span><span style=display:flex><span>                        }).Where(x =&gt; x.Location == city);
</span></span></code></pre></div><p>　　以下是目前的 provider 轉換出來的 SQL：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>From</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Select</span> ContactName, City <span style=color:#66d9ef>From</span> (
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>Select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>From</span> Customers
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>As</span> T
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>As</span> T <span style=color:#66d9ef>Where</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Location</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;London&#39;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>　　上面的 SQL 在執行時，會拋出異常，<code>Invalid column name 'Location'</code>，我們將成員訪問視為欄位引用過於簡化致使問題的產生。子樹中唯的的成員訪問不一定與欄位名稱匹配，所以我們需要其它的方法來改變欄位名以匹配，或是找到其它處理成員訪問的方法。<br>　　provider 要做的最終目的，其實只是將查詢表達式轉換成文字。文字只是 SQL 的一種表現形式，但對程式邏輯而言並不是一種好的表達方式，如果我們可以將 SQL 抽象化，那我們就能處理更複雜的轉換。<br>　　最適合操作的數據結構當然是<strong>語義 SQL 樹 (semantic SQL tree)</strong>，理想狀況下，我們會有一個完全獨立的 SQL 樹定義，可以將 LINQ 查詢表達式轉換成樹，這個理想的 SQL 樹的定義與 LINQ 樹有很多重疊之處，所以我們可以透過「教導」 LINQ 表達式樹有關 SQL 的知識，為此，我們需要新的表達式節點類型：</p><h2 id=自定義的-dbexpressiontype>自定義的 DbExpressionType<a hidden class=anchor aria-hidden=true href=#自定義的-dbexpressiontype>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>enum</span> DbExpressionType
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Table = <span style=color:#ae81ff>1000</span>,  <span style=color:#75715e>// 確保不與其它 ExpressionType 重覆</span>
</span></span><span style=display:flex><span>    Column,
</span></span><span style=display:flex><span>    Select,
</span></span><span style=display:flex><span>    Projection
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　接著創建各自的 <code>Expression</code> 繼承類別，與供 <code>SelectExpression</code> 使用的 <code>ColumnDeclaration</code>：</p><h2 id=tableexpression-實作>TableExpression 實作<a hidden class=anchor aria-hidden=true href=#tableexpression-實作>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TableExpression</span> : Expression
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> TableExpression(Type type, <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>alias</span>, <span style=color:#66d9ef>string</span> name)
</span></span><span style=display:flex><span>        : <span style=color:#66d9ef>base</span>((ExpressionType)DbExpressionType.Table, type)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>alias</span> = <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.name = name;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Alias =&gt; <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Name =&gt; name;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=columnexpression-實作>ColumnExpression 實作<a hidden class=anchor aria-hidden=true href=#columnexpression-實作>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ColumnExpression</span> : Expression
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ordinal;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> ColumnExpression(Type type, <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>alias</span>, <span style=color:#66d9ef>string</span> name, <span style=color:#66d9ef>int</span> ordinal)
</span></span><span style=display:flex><span>        : <span style=color:#66d9ef>base</span>((ExpressionType)DbExpressionType.Column, type)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>alias</span> = <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.name = name;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.ordinal = ordinal;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Alias =&gt; <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Name =&gt; name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>int</span> Ordinal =&gt; ordinal;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=columndeclaration-實作>ColumnDeclaration 實作<a hidden class=anchor aria-hidden=true href=#columndeclaration-實作>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ColumnDeclaration</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> name;
</span></span><span style=display:flex><span>    Expression expression;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> ColumnDeclaration(<span style=color:#66d9ef>string</span> name, Expression expression)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.name = name;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.expression = expression;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Name =&gt; name;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> Expression Expression =&gt; expression;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=selectexpression-實作>SelectExpression 實作<a hidden class=anchor aria-hidden=true href=#selectexpression-實作>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SelectExpression</span> : Expression
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>    ReadOnlyCollection&lt;ColumnDeclaration&gt; columns;
</span></span><span style=display:flex><span>    Expression <span style=color:#66d9ef>from</span>;
</span></span><span style=display:flex><span>    Expression <span style=color:#66d9ef>where</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> SelectExpression(Type type, <span style=color:#66d9ef>string</span> <span style=color:#66d9ef>alias</span>, IEnumerable&lt;ColumnDeclaration&gt; columns, Expression <span style=color:#66d9ef>from</span>, Expression <span style=color:#66d9ef>where</span>)
</span></span><span style=display:flex><span>        : <span style=color:#66d9ef>base</span>((ExpressionType)DbExpressionType.Select, type)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>alias</span> = <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.columns = columns <span style=color:#66d9ef>as</span> ReadOnlyCollection&lt;ColumnDeclaration&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.columns == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.columns = <span style=color:#66d9ef>new</span> List&lt;ColumnDeclaration&gt;(columns).AsReadOnly();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>from</span> = <span style=color:#66d9ef>from</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#66d9ef>where</span> = <span style=color:#66d9ef>where</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>string</span> Alias =&gt; <span style=color:#66d9ef>alias</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> ReadOnlyCollection&lt;ColumnDeclaration&gt; Columns =&gt; columns;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> Expression From =&gt; <span style=color:#66d9ef>from</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> Expression Where =&gt; <span style=color:#66d9ef>where</span>; 	
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=projectionexpression-實作>ProjectionExpression 實作<a hidden class=anchor aria-hidden=true href=#projectionexpression-實作>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProjectionExpression</span> :Expression
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	SelectExpression source;
</span></span><span style=display:flex><span>	Expression projector;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>internal</span> ProjectionExpression(SelectExpression source, Expression projector)
</span></span><span style=display:flex><span>		: <span style=color:#66d9ef>base</span>((ExpressionType)DbExpressionType.Projection, projector.Type)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.source = source;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>this</span>.projector = projector; 
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>internal</span> SelectExpression Source =&gt; source;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>internal</span> Expression Projector =&gt; projector; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>　　我們在目前的 LINQ 表達式樹中真正需要添加的 SQL 部分只有以下幾個概念：</p><ol><li>SQL Select 查詢，它可以生成一個或多個欄</li><li>對欄的引用</li><li>對表的引用</li><li>通過欄引用重新組裝物件的投影</li></ol><p>　　透過自定義 <code>DbExpressionType</code> 的 enum 類型，它擴充了 <code>ExpressionType</code>，通過選擇一個足夠大的起始值(table = 1000)，避免與其它定義發生衝突。這做為一個無法繼承 enum 類別時，另闢的途徑。<br>　　每個新的表達式節點都遵循由 LINQ 表達式設置的相同配置，只是現在它們模擬的是 SQL 概念而不是 CLR 概念。注意 <code>SelectExpression</code> 包含了一組<strong>欄的集合</strong>、<strong>from 表達式</strong>與 <strong>where 表達式</strong>。這是因為這個表達式節點的目的是要匹配一個合法的 <code>SQL Select</code> 語句所包含的內容。<br>　　<code>ProjectionExpression</code> 描述了如何根據 select 表達式的欄構建物件，這幾乎與先前的 <code>ProjectionReader</code> 的委托所扮演的角色完全相同。只不過這一次，我們可以根據 SQL 查詢來推理投影，而不僅僅將其視為從 DataReaders 中組裝物件。</p><h2 id=dbexpressionvisitor-實作>DbExpressionVisitor 實作<a hidden class=anchor aria-hidden=true href=#dbexpressionvisitor-實作>#</a></h2><p>　　既然我們有了新的節點，那我們就需要新的訪問器。<code>DbExpressionVisitor</code> 擴展了 <code>ExpressionVisitor</code>，為新節點添加基本的訪問模式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DbExpressionVisitor</span> : ExpressionVisitor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> Expression Visit(Expression exp)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (exp == <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> exp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> ((DbExpressionType)exp.NodeType)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> DbExpressionType.Table:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> VisitTable((TableExpression)exp);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> DbExpressionType.Column:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> VisitColumn((ColumnExpression)exp);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> DbExpressionType.Select:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> VisitSelect((SelectExpression)exp);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> DbExpressionType.Projection:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> VisitProjection((ProjectionExpression)exp);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>base</span>.Visit(exp);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitTable(TableExpression table)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> table;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitColumn(ColumnExpression column)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> column;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitSelect(SelectExpression <span style=color:#66d9ef>select</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Expression <span style=color:#66d9ef>from</span> = VisitSource(<span style=color:#66d9ef>select</span>.From);
</span></span><span style=display:flex><span>        Expression <span style=color:#66d9ef>where</span> = Visit(<span style=color:#66d9ef>select</span>.Where);
</span></span><span style=display:flex><span>        ReadOnlyCollection&lt;ColumnDeclaration&gt; columns = <span style=color:#66d9ef>this</span>.VisitColumnDeclaration(<span style=color:#66d9ef>select</span>.Columns);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>from</span> != <span style=color:#66d9ef>select</span>.From || <span style=color:#66d9ef>where</span> != <span style=color:#66d9ef>select</span>.Where || columns != <span style=color:#66d9ef>select</span>.Columns)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SelectExpression(<span style=color:#66d9ef>select</span>.Type, <span style=color:#66d9ef>select</span>.Alias, columns, <span style=color:#66d9ef>from</span>, <span style=color:#66d9ef>where</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>select</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitSource(Expression source)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.Visit(source);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>virtual</span> Expression VisitProjection(ProjectionExpression projection)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        SelectExpression source = (SelectExpression)<span style=color:#66d9ef>this</span>.Visit(projection.Source);
</span></span><span style=display:flex><span>        Expression projector = <span style=color:#66d9ef>this</span>.Visit(projection.Projector);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (source != projection.Source || projector != projection.Projector)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ProjectionExpression(source, projector);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> projection;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> ReadOnlyCollection&lt;ColumnDeclaration&gt; VisitColumnDeclarations(ReadOnlyCollection&lt;ColumnDeclaration&gt; columns)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        List&lt;ColumnDeclaration&gt; alternate = <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>; i &lt; columns.Count; i++)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            ColumnDeclaration column = columns[i]; 
</span></span><span style=display:flex><span>            Expression e = <span style=color:#66d9ef>this</span>.Visit(column.Expression);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (alternate == <span style=color:#66d9ef>null</span> &amp;&amp; e != column.Expression)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                alternate = columns.Take(i).ToList();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (alternate != <span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                alternate.Add(<span style=color:#66d9ef>new</span> ColumnDeclaration(column.Name, e));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> alternate?.AsReadOnly() ?? columns;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://intervalrain.github.io/tags/linq/>LINQ</a></li><li><a href=https://intervalrain.github.io/tags/c%23/>C#</a></li><li><a href=https://intervalrain.github.io/tags/iqueryable/>IQueryable</a></li></ul></footer><script src=https://utteranc.es/client.js repo=Reid00/hugo-blog-talks issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://intervalrain.github.io/>Rain Hu's Workspace</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="複製";function s(){t.innerHTML="已複製！",setTimeout(()=>{t.innerHTML="複製"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>